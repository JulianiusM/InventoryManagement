# Configuration Guide

This document describes the configuration system and available settings for the Inventory Management application.

## Settings Module

All configuration constants are centralized in `src/modules/settings.ts`. This ensures:
- **Single source of truth** - No duplicated constants across the codebase
- **Easy maintenance** - Change values in one place
- **Testability** - Settings can be overridden for tests
- **Environment-based configuration** - Settings can be customized via CSV file or environment variables

## Configuration Sources (Priority Order)

Settings are loaded with the following priority (highest to lowest):

1. **Environment variables** - E2E prefixed variables (e.g., `E2E_DB_HOST`) when `NODE_ENV=e2e`
2. **Environment variables** - Standard variables (e.g., `DB_HOST`)
3. **CSV file** - Settings from the configured CSV file (default: `settings.csv`)
4. **Default values** - Built-in defaults defined in `src/modules/settings.ts`

## Available Settings

### Database Configuration
- `dbType` - Database type ("mariadb" or "mysql", default: "mariadb")
- `dbHost` - Database host (default: "localhost")
- `dbPort` - Database port (default: 3306)
- `dbUser` - Database username (default: "user")
- `dbPassword` - Database password (default: "password")
- `dbName` - Database name (default: "database")

### Application Configuration
- `appPort` - Application port (default: 3000)
- `rootUrl` - Application root URL (default: "http://localhost:3000")
- `sessionSecret` - Session secret for cookies (auto-generated by default)

### Email Configuration
- `smtpHost` - SMTP server host
- `smtpPort` - SMTP server port (default: 465)
- `smtpSecure` - Use secure connection (default: true)
- `smtpEmail` - Email address for sending
- `smtpUser` - SMTP username
- `smtpPassword` - SMTP password
- `smtpPool` - Use connection pooling (default: true)

### Authentication Configuration
- `localLoginEnabled` - Enable local login (default: true)
- `oidcEnabled` - Enable OIDC authentication (default: false)
- `oidcName` - OIDC provider name
- `oidcClientId` - OIDC client ID
- `oidcClientSecret` - OIDC client secret
- `oidcIssuerBaseUrl` - OIDC issuer base URL
- `oidcRedirectUrl` - OIDC redirect URL

### Token Configuration
- `tokenExpirationMs` - Token expiration time in milliseconds (default: 3600000 = 1 hour)

### Rate Limiting Configuration
- `rateLimitWindowMs` - Rate limit window in milliseconds (default: 3600000 = 1 hour)
- `rateLimitMaxPushConnector` - Max requests per window for push connectors (default: 10)
- `rateLimitMaxDeviceRegistration` - Max device registrations per window (default: 5)

### Pagination Configuration
- `paginationDefaultItems` - Default items per page (default: 30)
- `paginationDefaultLocations` - Default locations per page (default: 50)
- `paginationDefaultGames` - Default games per page (default: 24)
- `paginationDefaultLoans` - Default loans per page (default: 30)
- `paginationMaxPerPage` - Maximum items per page (default: 100)
- `paginationMaxTimezoneItems` - Maximum timezone items to display (default: 200)

### Content Validation Configuration
- `minValidDescriptionLength` - Minimum description length to be considered valid (default: 50)
- `maxDescriptionLength` - Maximum description length for storage (default: 250)

### Game Metadata Configuration

#### Similar Title Matching
- `minNormalizedTitleLength` - Minimum title length for similarity matching (default: 4)
- `minSimilarityScore` - Minimum similarity score to create a pair (default: 50)

#### Wikidata Metadata Scoring
- `wikidataExactMatchScore` - Score for exact name matches (default: 500)
- `wikidataPrefixMatchScore` - Score for prefix matches (default: 150)
- `wikidataExpansionMatchScore` - Score for expansion matches (default: 80)
- `wikidataContainsMatchScore` - Score for contains matches (default: 50)
- `wikidataGameIndicatorBoost` - Boost for game-related terms (default: 100)
- `wikidataNoGameIndicatorPenalty` - Penalty for missing game indicators (default: 50)
- `wikidataNameLengthPenaltyFactor` - Factor for name length penalty (default: 0.5)
- `wikidataNonGamePenaltyScore` - Score for explicit non-games (default: -1000)
- `wikidataMinAcceptableScore` - Minimum acceptable score (default: -500)

#### Metadata Sync
- `igdbQueryTimeoutMs` - IGDB query timeout in milliseconds (default: 300000 = 5 minutes)

### External Provider API Keys
- `steamWebApiKey` - Steam Web API key (optional)
- `rawgApiKey` - RAWG API key (optional)
- `twitchClientId` - Twitch client ID (optional)
- `twitchClientSecret` - Twitch client secret (optional)
- `boardGameAtlasClientId` - Board Game Atlas client ID (optional)

### Legal Links
- `imprintUrl` - Imprint page URL
- `privacyPolicyUrl` - Privacy policy page URL

## Usage in Code

### Importing Settings
```typescript
import settings from '../modules/settings';
```

### Accessing Settings
```typescript
// Token expiration
const expiration = new Date(Date.now() + settings.value.tokenExpirationMs);

// Pagination
const perPage = options?.perPage || settings.value.paginationDefaultItems;
const maxPerPage = settings.value.paginationMaxPerPage;

// Rate limiting
const rateLimiter = rateLimit({
    windowMs: settings.value.rateLimitWindowMs,
    max: settings.value.rateLimitMaxPushConnector,
});

// Description validation
if (description.length < settings.value.minValidDescriptionLength) {
    // Handle short description
}
```

### Environment Variable Override
To override a setting via environment variable, use the CSV key name in uppercase:

```bash
# Override token expiration
export TOKEN_EXPIRATION_MS=7200000  # 2 hours

# Override pagination default
export PAGINATION_DEFAULT_ITEMS=50

# Override database settings
export DB_HOST=mysql.example.com
export DB_PORT=3307
export DB_NAME=mydb
```

### E2E Testing Override
For E2E tests, use the `E2E_` prefix:

```bash
export E2E_DB_NAME=surveyor_e2e
export E2E_TOKEN_EXPIRATION_MS=1800000
```

## CSV File Format

The settings CSV file has two columns: key and value.

Example `settings.csv`:
```csv
DB_TYPE,mariadb
DB_HOST,localhost
DB_PORT,3306
DB_NAME,inventory
PAGINATION_DEFAULT_ITEMS,50
TOKEN_EXPIRATION_MS,7200000
```

## Best Practices

1. **Never hardcode configuration values** in business logic
2. **Always use `settings.value.<property>`** to access configuration
3. **Document new settings** when adding them to the Settings type
4. **Add CSV mappings** in `keyMap` for any new settings
5. **Add type coercion** in `coerce` object for non-string types
6. **Keep defaults reasonable** for development and testing
7. **Use environment variables** for sensitive values (API keys, passwords)
8. **Test with different configurations** to ensure flexibility

## Security Notes

- **Never commit** API keys, passwords, or secrets in the CSV file
- **Use environment variables** for all sensitive configuration
- **Ensure `.env` files** are in `.gitignore`
- **Rotate secrets** regularly
- **Use different secrets** for development, testing, and production

## Related Documentation

- [Settings Module Source Code](../src/modules/settings.ts)
- [Development Guide](DEVELOPMENT.md)
- [Testing Guide](TESTING_GUIDE.md)
