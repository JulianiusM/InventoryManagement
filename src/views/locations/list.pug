extends ../layout

block meta
    title Locations | Inventory Management

//- Improved tree mixin with proper styling
mixin treeNode(node, depth)
    - depth = depth || 0
    .location-node(style=`margin-left: ${depth * 1.5}rem`)
        .d-flex.align-items-center.py-2.border-bottom.border-secondary
            //- Expand/collapse indicator
            if node.childrenNodes && node.childrenNodes.length
                i.bi.bi-chevron-down.me-2.text-white-50.small
            else
                i.bi.bi-dot.me-2.text-white-50
            //- Location icon based on kind
            case node.kind
                when 'room'
                    i.bi.bi-house.me-2.text-info
                when 'shelf'
                    i.bi.bi-columns-gap.me-2.text-info
                when 'box'
                    i.bi.bi-box.me-2.text-info
                when 'bin'
                    i.bi.bi-archive.me-2.text-info
                when 'drawer'
                    i.bi.bi-layout-sidebar.me-2.text-info
                when 'cabinet'
                    i.bi.bi-grid.me-2.text-info
                default
                    i.bi.bi-geo.me-2.text-info
            //- Location link
            a.text-white.text-decoration-none.flex-grow-1(href=`/locations/${node.id}`)
                | #{node.name}
            //- Badges
            span.badge.text-bg-secondary.me-2 #{node.kind}
            if node.qrCode
                span.badge.text-bg-dark.border.border-secondary.me-2
                    i.bi.bi-qr-code.me-1
                    | QR
        //- Children
        if node.childrenNodes && node.childrenNodes.length
            each child in node.childrenNodes
                +treeNode(child, depth + 1)

block content
    - const locations = (data && data.locations) ? data.locations : []
    - const tree = (data && data.tree) ? data.tree : []
    - const locationKinds = ['room', 'shelf', 'box', 'bin', 'drawer', 'cabinet', 'other']

    #liveAlerts

    //- Breadcrumb navigation
    nav.mb-2(aria-label="breadcrumb")
        ol.breadcrumb.mb-0
            li.breadcrumb-item
                a.text-white(href="/") Home
            li.breadcrumb-item.active.text-white-50(aria-current="page") Locations

    .d-flex.justify-content-between.align-items-center.mb-3
        h1.h3.mb-0.text-white
            i.bi.bi-geo-alt.me-2
            | Locations
            if locations.length > 0
                span.badge.text-bg-secondary.ms-2.fs-6 #{locations.length}

    //- Search box
    if locations.length > 5
        .card.text-bg-dark.border-secondary.mb-3
            .card-body.py-2
                .input-group
                    span.input-group-text.text-bg-dark.border-secondary
                        i.bi.bi-search
                    input#locationSearch.form-control.text-bg-dark.border-secondary(type="text" placeholder="Search locations..." autocomplete="off")

    //- Add location form (collapsible)
    .card.text-bg-dark.border-secondary.mb-4
        .card-header.d-flex.justify-content-between.align-items-center(data-bs-toggle="collapse" data-bs-target="#addLocationForm" style="cursor: pointer")
            h2.h5.mb-0
                i.bi.bi-plus-circle.me-2
                | Add New Location
            i.bi.bi-chevron-down
        #addLocationForm.collapse.show
            .card-body
                form.row.g-3(method="post" action="/locations")
                    .col-md-5
                        label.form-label(for="name")
                            i.bi.bi-tag.me-1
                            | Name *
                        input#name.form-control.text-bg-dark(type="text" name="name" required placeholder="e.g. Garage Shelf A")
                    .col-md-3
                        label.form-label(for="kind")
                            i.bi.bi-grid.me-1
                            | Kind
                        select#kind.form-select.text-bg-dark(name="kind")
                            each k in locationKinds
                                option(value=k selected=(k === 'other')) #{k.charAt(0).toUpperCase() + k.slice(1)}
                    .col-md-4
                        label.form-label(for="parentId")
                            i.bi.bi-diagram-3.me-1
                            | Parent Location
                        select#parentId.form-select.text-bg-dark(name="parentId")
                            option(value="") None (top-level)
                            each loc in locations
                                option(value=loc.id) #{loc.name}
                    .col-md-8
                        label.form-label(for="qrCode")
                            i.bi.bi-qr-code.me-1
                            | QR Code (optional)
                        input#qrCode.form-control.text-bg-dark(type="text" name="qrCode" placeholder="e.g. LOC:garage-shelf-1")
                        .form-text.text-white-50 Assign a unique code for scanning. Use prefix like LOC: to identify locations.
                    .col-md-4.d-flex.align-items-end
                        button.btn.btn-primary.w-100(type="submit")
                            i.bi.bi-plus-lg.me-1
                            | Create Location

    //- Location tree
    .card.text-bg-dark.border-secondary
        .card-header
            h2.h5.mb-0
                i.bi.bi-diagram-3.me-2
                | Location Tree
        .card-body
            if tree.length === 0
                .text-center.py-4
                    i.bi.bi-geo-alt.display-1.text-white-50.mb-3.d-block
                    p.text-white-50.mb-0 No locations yet. Create your first location above!
            else
                #locationTree
                    each root in tree
                        +treeNode(root, 0)

block scripts
    script.
        // Location search
        document.addEventListener('DOMContentLoaded', function() {
            const searchInput = document.getElementById('locationSearch');
            const tree = document.getElementById('locationTree');
            
            if (searchInput && tree) {
                searchInput.addEventListener('input', function() {
                    const query = this.value.toLowerCase();
                    const nodes = tree.querySelectorAll('.location-node');
                    
                    nodes.forEach(node => {
                        const link = node.querySelector('a');
                        const name = link ? link.textContent.toLowerCase() : '';
                        
                        if (!query || name.includes(query)) {
                            node.style.display = '';
                            // Show all parent nodes
                            let parent = node.parentElement;
                            while (parent && parent !== tree) {
                                if (parent.classList.contains('location-node')) {
                                    parent.style.display = '';
                                }
                                parent = parent.parentElement;
                            }
                        } else {
                            node.style.display = 'none';
                        }
                    });
                });
            }
        });
