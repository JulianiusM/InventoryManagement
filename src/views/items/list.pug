extends ../layout

block meta
    title Items | Inventory Management

block content
    - const items = (data && data.items) ? data.items : []
    - const locations = (data && data.locations) ? data.locations : []
    - const pagination = (data && data.pagination) ? data.pagination : {page: 1, totalPages: 1, totalItems: items.length, perPage: 30}
    - const filters = (data && data.filters) ? data.filters : {search: '', type: '', location: ''}
    - const itemTypes = ['book', 'tool', 'game', 'electronics', 'clothing', 'collectible', 'other']
    - const conditions = ['new', 'like_new', 'good', 'fair', 'poor']

    include ../modules/module_pagination

    #liveAlerts

    //- Breadcrumb
    nav.mb-2(aria-label="breadcrumb")
        ol.breadcrumb.mb-0
            li.breadcrumb-item
                a.text-white(href="/") Home
            li.breadcrumb-item.active.text-white-50(aria-current="page") Items

    .d-flex.justify-content-between.align-items-center.mb-3.flex-wrap.gap-2
        h1.h3.mb-0.text-white
            i.bi.bi-box-seam.me-2
            | Items
            if pagination.totalItems > 0
                span.badge.text-bg-secondary.ms-2.fs-6 #{pagination.totalItems}
        
        //- Items per page selector on desktop
        .d-none.d-md-block
            +itemsPerPageSelector(pagination.perPage, '/items')

    //- Enhanced search and filter row
    .card.text-bg-dark.border-secondary.mb-3
        .card-body.py-2
            form(method="get" action="/items")
                .row.g-2.align-items-center
                    .col-md-4
                        .input-group
                            span.input-group-text.text-bg-dark.border-secondary
                                i.bi.bi-search
                            input#itemSearch.form-control.text-bg-dark.border-secondary(
                                type="text" 
                                name="search" 
                                placeholder="Search by name, description, tags..." 
                                value=filters.search
                                autocomplete="off"
                            )
                            button.btn.btn-outline-secondary(type="button" data-search-clear style=filters.search ? '' : 'display:none')
                                i.bi.bi-x-lg
                    .col-md-3
                        select#filterType.form-select.text-bg-dark.border-secondary(name="type")
                            option(value="" selected=!filters.type) All types
                            each t in itemTypes
                                option(value=t selected=filters.type === t) #{t.charAt(0).toUpperCase() + t.slice(1)}
                    .col-md-3
                        select#filterLocation.form-select.text-bg-dark.border-secondary(name="location")
                            option(value="" selected=!filters.location) All locations
                            option(value="unassigned" selected=filters.location === 'unassigned') Unassigned
                            each loc in locations
                                option(value=loc.id selected=filters.location === loc.id) #{loc.name}
                    .col-md-2
                        .d-flex.gap-1
                            button.btn.btn-primary.flex-grow-1(type="submit")
                                i.bi.bi-funnel.me-1
                                span.d-none.d-lg-inline Filter
                                span.d-lg-none
                                    i.bi.bi-check
                            a.btn.btn-outline-secondary(href="/items" title="Clear filters")
                                i.bi.bi-x-lg

    //- Items per page selector on mobile
    .d-md-none.mb-3
        +itemsPerPageSelector(pagination.perPage, '/items')

    //- Add item form (collapsible)
    .card.text-bg-dark.border-secondary.mb-4
        .card-header.d-flex.justify-content-between.align-items-center(data-bs-toggle="collapse" data-bs-target="#addItemForm" style="cursor: pointer")
            h2.h5.mb-0
                i.bi.bi-plus-circle.me-2
                | Add New Item
            i.bi.bi-chevron-down
        #addItemForm.collapse
            .card-body
                form.row.g-3(method="post" action="/items")
                    .col-md-5
                        label.form-label(for="name")
                            i.bi.bi-tag.me-1
                            | Name *
                        input#name.form-control.text-bg-dark(type="text" name="name" required placeholder="Enter item name")
                    .col-md-3
                        label.form-label(for="type")
                            i.bi.bi-grid.me-1
                            | Type
                        select#type.form-select.text-bg-dark(name="type")
                            each t in itemTypes
                                option(value=t selected=(t === 'other')) #{t.charAt(0).toUpperCase() + t.slice(1).replace('_', ' ')}
                    .col-md-4
                        label.form-label(for="locationId")
                            i.bi.bi-geo-alt.me-1
                            | Location
                        select#locationId.form-select.text-bg-dark(name="locationId")
                            option(value="") Unassigned
                            each loc in locations
                                option(value=loc.id) #{loc.name}
                    .col-md-3
                        label.form-label(for="condition")
                            i.bi.bi-heart.me-1
                            | Condition
                        select#condition.form-select.text-bg-dark(name="condition")
                            option(value="") Not specified
                            each c in conditions
                                option(value=c) #{c.charAt(0).toUpperCase() + c.slice(1).replace('_', ' ')}
                    .col-md-3
                        label.form-label(for="serialNumber")
                            i.bi.bi-hash.me-1
                            | Serial Number
                        input#serialNumber.form-control.text-bg-dark(type="text" name="serialNumber" placeholder="Optional")
                    .col-md-6
                        label.form-label(for="tags")
                            i.bi.bi-tags.me-1
                            | Tags
                        input#tags.form-control.text-bg-dark(type="text" name="tags" placeholder="Comma-separated tags, e.g. electronics, red, vintage")
                    .col-12
                        label.form-label(for="description")
                            i.bi.bi-text-left.me-1
                            | Description
                        textarea#description.form-control.text-bg-dark(name="description" rows="2" placeholder="Optional notes about this item")
                    .col-12
                        button.btn.btn-primary(type="submit")
                            i.bi.bi-plus-lg.me-1
                            | Create Item

    //- Items list
    if pagination.totalItems === 0
        .card.text-bg-dark.border-secondary
            .card-body.text-center.py-5
                i.bi.bi-inbox.display-1.text-white-50.mb-3.d-block
                if filters.search || filters.type || filters.location
                    p.text-white-50.mb-3 No items match your filters.
                    a.btn.btn-outline-light(href="/items") Clear filters
                else
                    p.text-white-50.mb-3 No items yet. Add your first item above!
                    a.btn.btn-outline-light(href="/scan")
                        i.bi.bi-upc-scan.me-1
                        | Or scan a barcode
    else
        .card.text-bg-dark.border-secondary
            .card-body
                //- Desktop table view
                .table-responsive.d-none.d-md-block
                    table.table.table-dark.table-hover.align-middle.mb-0
                        thead
                            tr
                                th(style="width: 30%") Name
                                th Type
                                th Condition
                                th Location
                                th Created
                                th.text-end(style="width: 100px") Actions
                        tbody
                            each it in items
                                tr
                                    td
                                        a.text-white.text-decoration-none(href=`/items/${it.id}`)
                                            i.bi.bi-box.me-2.text-white-50
                                            | #{it.name}
                                        if it.tags && it.tags.length
                                            br
                                            each tag in it.tags.slice(0, 2)
                                                span.badge.text-bg-secondary.me-1.small #{tag}
                                            if it.tags.length > 2
                                                span.badge.text-bg-secondary.small +#{it.tags.length - 2}
                                    td
                                        span.badge.text-bg-info #{it.type}
                                    td.text-white-50 #{it.condition ? it.condition.replace('_', ' ') : 'â€”'}
                                    td
                                        if it.location
                                            a.text-white.text-decoration-none(href=`/locations/${it.location.id}`)
                                                i.bi.bi-geo-alt-fill.me-1.text-white-50
                                                | #{it.location.name}
                                        else
                                            span.text-white-50 Unassigned
                                    td.text-white-50.small #{new Date(it.createdAt).toLocaleDateString()}
                                    td.text-end
                                        .btn-group.btn-group-sm
                                            a.btn.btn-outline-light(href=`/items/${it.id}` title="View details")
                                                i.bi.bi-eye
                                            a.btn.btn-outline-primary(href=`/items/${it.id}#move` title="Move item")
                                                i.bi.bi-arrow-right-square
                
                //- Mobile card view
                .d-md-none
                    each it in items
                        .card.text-bg-dark.border-secondary.mb-3
                            .card-body
                                .d-flex.justify-content-between.align-items-start.mb-2
                                    div
                                        a.text-white.text-decoration-none.h6(href=`/items/${it.id}`)
                                            i.bi.bi-box.me-2
                                            | #{it.name}
                                        div.mt-1
                                            span.badge.text-bg-info.me-1 #{it.type}
                                            if it.condition
                                                span.badge.text-bg-secondary #{it.condition.replace('_', ' ')}
                                    a.btn.btn-sm.btn-outline-light(href=`/items/${it.id}`)
                                        i.bi.bi-eye
                                hr.border-secondary
                                .row.g-2.small
                                    .col-6
                                        .text-white-50 Location:
                                        if it.location
                                            a.text-white.text-decoration-none(href=`/locations/${it.location.id}`)
                                                i.bi.bi-geo-alt.me-1
                                                | #{it.location.name}
                                        else
                                            span.text-white-50 Unassigned
                                    .col-6
                                        .text-white-50 Created:
                                        .text-white #{new Date(it.createdAt).toLocaleDateString()}
                                    if it.tags && it.tags.length
                                        .col-12.mt-2
                                            each tag in it.tags
                                                span.badge.text-bg-secondary.me-1.small #{tag}
                
                //- Pagination
                +pagination(pagination.page, pagination.totalPages, '/items')

block scripts
    script(src="/js/enhanced-search.js")
    script.
        // Enhanced search with query preservation
        document.addEventListener('DOMContentLoaded', function() {
            const searchInput = document.getElementById('itemSearch');
            const clearBtn = document.querySelector('[data-search-clear]');
            
            // Show/hide clear button
            if (searchInput && clearBtn) {
                searchInput.addEventListener('input', function() {
                    clearBtn.style.display = this.value ? '' : 'none';
                });
                
                clearBtn.addEventListener('click', function() {
                    searchInput.value = '';
                    this.style.display = 'none';
                    searchInput.focus();
                });
            }
        });
