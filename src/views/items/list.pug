extends ../layout

block meta
    title Items | Inventory Management

block content
    - const items = (data && data.items) ? data.items : []
    - const locations = (data && data.locations) ? data.locations : []
    - const pagination = (data && data.pagination) ? data.pagination : {page: 1, totalPages: 1, totalItems: items.length, perPage: 30}
    - const filters = (data && data.filters) ? data.filters : {search: '', type: '', location: ''}
    - const itemTypes = ['book', 'tool', 'game', 'electronics', 'clothing', 'collectible', 'other']
    - const conditions = ['new', 'like_new', 'good', 'fair', 'poor']

    include ../modules/module_pagination

    #liveAlerts

    .d-flex.justify-content-between.align-items-center.mb-3.flex-wrap.gap-2
        h1.h3.mb-0.text-white
            i.bi.bi-box-seam.me-2
            | Items
            if pagination.totalItems > 0
                span.badge.text-bg-secondary.ms-2.fs-6 #{pagination.totalItems}
        
        .d-flex.gap-2.align-items-center.flex-wrap
            //- Items per page selector on desktop
            .d-none.d-md-block
                +itemsPerPageSelector(pagination.perPage, '/items')
            //- Add button to open modal
            button.btn.btn-primary(type="button" data-bs-toggle="modal" data-bs-target="#addItemModal")
                i.bi.bi-plus-lg.me-1
                | Add Item

    //- Enhanced search and filter row
    .card.text-bg-dark.border-secondary.mb-3
        .card-body.py-2
            form(method="get" action="/items")
                .row.g-2.align-items-center
                    .col-md-5
                        .input-group
                            span.input-group-text.text-bg-dark.border-secondary
                                i.bi.bi-search
                            input#itemSearch.form-control.text-bg-dark.border-secondary(
                                type="text" 
                                name="search" 
                                placeholder="Search by name, description, tags..." 
                                value=filters.search
                                autocomplete="off"
                            )
                            if filters.search
                                button.btn.btn-outline-secondary(type="button" data-search-clear)
                                    i.bi.bi-x-lg
                    .col-md-3
                        select#filterType.form-select.text-bg-dark.border-secondary(name="type")
                            option(value="" selected=!filters.type) All types
                            each t in itemTypes
                                option(value=t selected=filters.type === t) #{t.charAt(0).toUpperCase() + t.slice(1)}
                    .col-md-2
                        select#filterLocation.form-select.text-bg-dark.border-secondary.select2-filter-location(name="location")
                            option(value="" selected=!filters.location) All locations
                            option(value="unassigned" selected=filters.location === 'unassigned') Unassigned
                            each loc in locations
                                option(value=loc.id selected=filters.location === loc.id) #{loc.name}
                    .col-md-2
                        button.btn.btn-primary.w-100(type="submit")
                            i.bi.bi-funnel.me-1
                            | Filter
                        if filters.search || filters.type || filters.location
                            a.btn.btn-outline-secondary.w-100.mt-1(href="/items")
                                i.bi.bi-arrow-counterclockwise.me-1
                                | Reset

    //- Items per page selector on mobile
    .d-md-none.mb-3
        +itemsPerPageSelector(pagination.perPage, '/items')

    //- Items list
    if pagination.totalItems === 0
        .card.text-bg-dark.border-secondary
            .card-body.text-center.py-5
                i.bi.bi-inbox.display-1.text-white-50.mb-3.d-block
                if filters.search || filters.type || filters.location
                    p.text-white-50.mb-3 No items match your filters.
                    a.btn.btn-outline-light(href="/items") Clear filters
                else
                    p.text-white-50.mb-3 No items yet. Add your first item above!
                    a.btn.btn-outline-light(href="/scan")
                        i.bi.bi-upc-scan.me-1
                        | Or scan a barcode
    else
        .card.text-bg-dark.border-secondary
            .card-body
                //- Desktop table view
                .table-responsive.d-none.d-md-block
                    table.table.table-dark.table-hover.align-middle.mb-0
                        thead
                            tr
                                th(style="width: 30%") Name
                                th Type
                                th Condition
                                th Location
                                th Created
                                th.text-end(style="width: 100px") Actions
                        tbody
                            each it in items
                                tr
                                    td
                                        a.text-white.text-decoration-none(href=`/items/${it.id}`)
                                            i.bi.bi-box.me-2.text-white-50
                                            | #{it.name}
                                        if it.tags && it.tags.length
                                            br
                                            each tag in it.tags.slice(0, 2)
                                                span.badge.text-bg-secondary.me-1.small #{tag}
                                            if it.tags.length > 2
                                                span.badge.text-bg-secondary.small +#{it.tags.length - 2}
                                    td
                                        span.badge.text-bg-info #{it.type}
                                    td.text-white-50 #{it.condition ? it.condition.replace('_', ' ') : 'â€”'}
                                    td
                                        if it.location
                                            a.text-white.text-decoration-none(href=`/locations/${it.location.id}`)
                                                i.bi.bi-geo-alt-fill.me-1.text-white-50
                                                | #{it.location.name}
                                        else
                                            span.text-white-50 Unassigned
                                    td.text-white-50.small #{new Date(it.createdAt).toLocaleDateString()}
                                    td.text-end
                                        .btn-group.btn-group-sm
                                            a.btn.btn-outline-light(href=`/items/${it.id}` title="View details")
                                                i.bi.bi-eye
                                            a.btn.btn-outline-primary(href=`/items/${it.id}#move` title="Move item")
                                                i.bi.bi-arrow-right-square
                
                //- Mobile card view
                .d-md-none
                    each it in items
                        .card.text-bg-dark.border-secondary.mb-3
                            .card-body
                                .d-flex.justify-content-between.align-items-start.mb-2
                                    div
                                        a.text-white.text-decoration-none.h6(href=`/items/${it.id}`)
                                            i.bi.bi-box.me-2
                                            | #{it.name}
                                        div.mt-1
                                            span.badge.text-bg-info.me-1 #{it.type}
                                            if it.condition
                                                span.badge.text-bg-secondary #{it.condition.replace('_', ' ')}
                                    a.btn.btn-sm.btn-outline-light(href=`/items/${it.id}`)
                                        i.bi.bi-eye
                                hr.border-secondary
                                .row.g-2.small
                                    .col-6
                                        .text-white-50 Location:
                                        if it.location
                                            a.text-white.text-decoration-none(href=`/locations/${it.location.id}`)
                                                i.bi.bi-geo-alt.me-1
                                                | #{it.location.name}
                                        else
                                            span.text-white-50 Unassigned
                                    .col-6
                                        .text-white-50 Created:
                                        .text-white #{new Date(it.createdAt).toLocaleDateString()}
                                    if it.tags && it.tags.length
                                        .col-12.mt-2
                                            each tag in it.tags
                                                span.badge.text-bg-secondary.me-1.small #{tag}
                
                //- Pagination
                +pagination(pagination.page, pagination.totalPages, '/items')

    //- Add Item Modal
    #addItemModal.modal.fade(tabindex="-1" aria-labelledby="addItemModalLabel" aria-hidden="true")
        .modal-dialog.modal-lg
            .modal-content.text-bg-dark
                .modal-header.border-secondary
                    h5.modal-title#addItemModalLabel
                        i.bi.bi-plus-circle.me-2
                        | Add New Item
                    button.btn-close.btn-close-white(type="button" data-bs-dismiss="modal" aria-label="Close")
                .modal-body
                    form#addItemForm.row.g-3(method="post" action="/items")
                        .col-md-6
                            label.form-label(for="modalName")
                                i.bi.bi-tag.me-1
                                | Name *
                            input#modalName.form-control.text-bg-dark(type="text" name="name" required placeholder="Enter item name")
                        .col-md-6
                            label.form-label(for="modalType")
                                i.bi.bi-grid.me-1
                                | Type
                            select#modalType.form-select.text-bg-dark(name="type")
                                each t in itemTypes
                                    option(value=t selected=(t === 'other')) #{t.charAt(0).toUpperCase() + t.slice(1).replace('_', ' ')}
                        .col-md-6
                            label.form-label(for="modalLocationId")
                                i.bi.bi-geo-alt.me-1
                                | Location
                            select#modalLocationId.form-select.text-bg-dark.select2-location(name="locationId")
                                option(value="") Unassigned
                                each loc in locations
                                    option(value=loc.id) #{loc.name}
                        .col-md-6
                            label.form-label(for="modalCondition")
                                i.bi.bi-heart.me-1
                                | Condition
                            select#modalCondition.form-select.text-bg-dark(name="condition")
                                option(value="") Not specified
                                each c in conditions
                                    option(value=c) #{c.charAt(0).toUpperCase() + c.slice(1).replace('_', ' ')}
                        .col-md-6
                            label.form-label(for="modalSerialNumber")
                                i.bi.bi-hash.me-1
                                | Serial Number
                            input#modalSerialNumber.form-control.text-bg-dark(type="text" name="serialNumber" placeholder="Optional")
                        .col-md-6
                            label.form-label(for="modalTags")
                                i.bi.bi-tags.me-1
                                | Tags
                            input#modalTags.form-control.text-bg-dark(type="text" name="tags" placeholder="Comma-separated tags")
                        .col-12
                            label.form-label(for="modalDescription")
                                i.bi.bi-text-left.me-1
                                | Description
                            textarea#modalDescription.form-control.text-bg-dark(name="description" rows="3" placeholder="Optional notes about this item")
                .modal-footer.border-secondary
                    button.btn.btn-secondary(type="button" data-bs-dismiss="modal") Cancel
                    button.btn.btn-primary(type="submit" form="addItemForm")
                        i.bi.bi-plus-lg.me-1
                        | Create Item

block scripts
    script(src="/js/enhanced-search.js")
    script.
        // Enhanced search with query preservation
        document.addEventListener('DOMContentLoaded', function() {
            const searchInput = document.getElementById('itemSearch');
            const clearBtn = document.querySelector('[data-search-clear]');
            
            // Clear button handler
            if (clearBtn) {
                clearBtn.addEventListener('click', function() {
                    searchInput.value = '';
                    searchInput.focus();
                });
            }
            
            // Initialize Select2 for location dropdown in modal
            if (typeof $ !== 'undefined' && $.fn.select2) {
                $('.select2-location').select2({
                    theme: 'bootstrap-5',
                    dropdownParent: $('#addItemModal'),
                    placeholder: 'Select a location',
                    allowClear: true,
                    width: '100%'
                });
                
                // Initialize Select2 for filter location dropdown
                $('.select2-filter-location').select2({
                    theme: 'bootstrap-5',
                    placeholder: 'All locations',
                    allowClear: true,
                    width: '100%'
                });
            }
        });
