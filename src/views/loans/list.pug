extends ../layout

block meta
    title Lending | Inventory Management

block content
    - const items = (data && data.items) ? data.items : []
    - const loans = (data && data.loans) ? data.loans : []
    - const allLoans = (data && data.allLoans) ? data.allLoans : []
    - const paginatedLoans = (data && data.paginatedLoans) ? data.paginatedLoans : null
    - const pagination = (data && data.pagination) ? data.pagination : {page: 1, totalPages: 1, totalItems: 0, perPage: 30, tab: 'active'}
    - const overdueLoans = loans.filter(l => l.status === 'overdue' || (l.dueAt && new Date(l.dueAt) < new Date() && l.status === 'active'))
    - const conditions = ['new', 'like_new', 'good', 'fair', 'poor']

    include ../modules/module_pagination

    #liveAlerts

    .d-flex.justify-content-between.align-items-center.mb-3
        h1.h3.mb-0.text-white
            i.bi.bi-arrow-left-right.me-2
            | Lending
        button.btn.btn-primary(type="button" data-bs-toggle="modal" data-bs-target="#newLoanModal")
            i.bi.bi-plus-lg.me-1
            | New Loan

    //- Stats row
    .row.row-cols-2.row-cols-md-4.g-3.mb-4
        .col
            .card.h-100.text-bg-dark.border-secondary
                .card-body.text-center.py-2
                    h3.h4.mb-0 #{loans.length}
                    small.text-white-50 Active Loans
        .col
            .card.h-100.text-bg-dark.border-secondary(class=overdueLoans.length > 0 ? 'border-danger' : '')
                .card-body.text-center.py-2
                    h3.h4.mb-0(class=overdueLoans.length > 0 ? 'text-danger' : '') #{overdueLoans.length}
                    small(class=overdueLoans.length > 0 ? 'text-danger' : 'text-white-50') Overdue
        .col
            .card.h-100.text-bg-dark.border-secondary
                .card-body.text-center.py-2
                    h3.h4.mb-0 #{loans.filter(l => l.direction === 'lend').length}
                    small.text-white-50 Lending Out
        .col
            .card.h-100.text-bg-dark.border-secondary
                .card-body.text-center.py-2
                    h3.h4.mb-0 #{loans.filter(l => l.direction === 'borrow').length}
                    small.text-white-50 Borrowing

    //- Tabs for active and history
    ul.nav.nav-tabs.mb-0(role="tablist")
        li.nav-item
            a.nav-link.text-bg-dark.border-secondary(
                href="/loans?tab=active"
                class=pagination.tab === 'active' ? 'active' : ''
            )
                i.bi.bi-clock.me-1
                | Active
                if loans.length > 0
                    span.badge.text-bg-primary.ms-2 #{loans.length}
        li.nav-item
            a.nav-link.text-bg-dark.border-secondary(
                href="/loans?tab=history"
                class=pagination.tab === 'history' ? 'active' : ''
            )
                i.bi.bi-clock-history.me-1
                | History
                if allLoans.length > loans.length
                    span.badge.text-bg-secondary.ms-2 #{allLoans.length - loans.length}

    .tab-content
        //- Active loans tab
        if pagination.tab === 'active'
            .card.text-bg-dark.border-secondary.border-top-0.rounded-top-0
                .card-body
                    if loans.length === 0
                        .text-center.py-4
                            i.bi.bi-inbox.display-4.text-white-50.mb-2.d-block
                            p.text-white-50.mb-2 No active loans.
                            button.btn.btn-outline-light(type="button" data-bs-toggle="modal" data-bs-target="#newLoanModal")
                                i.bi.bi-plus-lg.me-1
                                | Create your first loan
                    else
                        .table-responsive
                            table.table.table-dark.table-hover.align-middle.mb-0
                                thead
                                    tr
                                        th Item
                                        th Direction
                                        th Counterparty
                                        th Condition
                                        th Started
                                        th Due
                                        th.text-end Actions
                                tbody
                                    each l in loans
                                        - const isOverdue = l.dueAt && new Date(l.dueAt) < new Date()
                                        tr(class=isOverdue ? 'table-danger' : '')
                                            td
                                                a.text-white.text-decoration-none(href=`/items/${l.item.id}`)
                                                    i.bi.bi-box.me-2.text-white-50
                                                    | #{l.item.name}
                                            td
                                                if l.direction === 'lend'
                                                    span.badge.text-bg-primary
                                                        i.bi.bi-arrow-right.me-1
                                                        | Lending
                                                else
                                                    span.badge.text-bg-secondary
                                                        i.bi.bi-arrow-left.me-1
                                                        | Borrowing
                                            td
                                                i.bi.bi-person.me-2.text-white-50
                                                | #{l.party.name}
                                                if l.party.email
                                                    .small.text-white-50 #{l.party.email}
                                            td.text-white-50 #{l.conditionOut ? l.conditionOut.replace('_', ' ') : '—'}
                                            td.text-white-50.small #{new Date(l.startAt).toLocaleDateString()}
                                            td
                                                if l.dueAt
                                                    span(class=isOverdue ? 'text-danger fw-bold' : 'text-white-50')
                                                        if isOverdue
                                                            i.bi.bi-exclamation-triangle.me-1
                                                        | #{new Date(l.dueAt).toLocaleDateString()}
                                                else
                                                    span.text-white-50 —
                                            td.text-end
                                                .btn-group.btn-group-sm
                                                    button.btn.btn-outline-success.loan-return(type="button" data-loan-id=l.id title="Mark as returned")
                                                        i.bi.bi-check-lg.me-1
                                                        | Return

        //- History tab
        if pagination.tab === 'history'
            .card.text-bg-dark.border-secondary.border-top-0.rounded-top-0
                .card-body
                    - const returnedLoans = paginatedLoans || allLoans.filter(l => l.status === 'returned')
                    if returnedLoans.length === 0
                        .text-center.py-4
                            i.bi.bi-clock-history.display-4.text-white-50.mb-2.d-block
                            p.text-white-50.mb-0 No loan history yet. Returned loans will appear here.
                    else
                        .table-responsive
                            table.table.table-dark.table-hover.align-middle.mb-0
                                thead
                                    tr
                                        th Item
                                        th Direction
                                        th Counterparty
                                        th Condition Out
                                        th Condition In
                                        th Period
                                tbody
                                    each l in returnedLoans
                                        tr
                                            td
                                                a.text-white.text-decoration-none(href=`/items/${l.item.id}`)
                                                    i.bi.bi-box.me-2.text-white-50
                                                    | #{l.item.name}
                                            td
                                                if l.direction === 'lend'
                                                    span.badge.text-bg-primary Lent
                                                else
                                                    span.badge.text-bg-secondary Borrowed
                                            td
                                                | #{l.party.name}
                                            td.text-white-50 #{l.conditionOut ? l.conditionOut.replace('_', ' ') : '—'}
                                            td.text-white-50 #{l.conditionIn ? l.conditionIn.replace('_', ' ') : '—'}
                                            td.text-white-50.small
                                                | #{new Date(l.startAt).toLocaleDateString()}
                                                | →
                                                | #{l.returnedAt ? new Date(l.returnedAt).toLocaleDateString() : '—'}
                        
                        //- Pagination for history
                        +pagination(pagination.page, pagination.totalPages, '/loans?tab=history')

    //- New Loan Modal
    #newLoanModal.modal.fade(tabindex="-1" aria-labelledby="newLoanModalLabel" aria-hidden="true")
        .modal-dialog.modal-lg
            .modal-content.text-bg-dark
                .modal-header.border-secondary
                    h5.modal-title#newLoanModalLabel
                        i.bi.bi-plus-circle.me-2
                        | New Loan
                    button.btn-close.btn-close-white(type="button" data-bs-dismiss="modal" aria-label="Close")
                .modal-body
                    if items.length === 0
                        .alert.alert-warning.mb-0
                            i.bi.bi-exclamation-triangle.me-2
                            | You need to 
                            a.alert-link(href="/items") add some items
                            |  before you can create a loan.
                    else
                        form#newLoanForm.row.g-3(method="post" action="/loans")
                            .col-md-6
                                label.form-label(for="modalItemId")
                                    i.bi.bi-box.me-1
                                    | Item *
                                select#modalItemId.form-select.text-bg-dark.select2-item(name="itemId" required)
                                    option(value="" disabled selected) Select an item...
                                    each it in items
                                        option(value=it.id) #{it.name} (#{it.type})
                            .col-md-6
                                label.form-label(for="modalDirection")
                                    i.bi.bi-arrow-left-right.me-1
                                    | Type *
                                select#modalDirection.form-select.text-bg-dark(name="direction")
                                    option(value="lend" selected) Lending out
                                    option(value="borrow") Borrowing
                            .col-md-6
                                label.form-label(for="modalConditionOut")
                                    i.bi.bi-heart.me-1
                                    | Condition at handoff
                                select#modalConditionOut.form-select.text-bg-dark(name="conditionOut")
                                    option(value="") Not specified
                                    each c in conditions
                                        option(value=c) #{c.charAt(0).toUpperCase() + c.slice(1).replace('_', ' ')}
                            .col-md-6
                                label.form-label(for="modalDueAt")
                                    i.bi.bi-calendar.me-1
                                    | Due Date (optional)
                                input#modalDueAt.form-control.text-bg-dark(type="date" name="dueAt")
                            .col-md-12
                                label.form-label(for="modalPartyName")
                                    i.bi.bi-person.me-1
                                    | Counterparty Name *
                                input#modalPartyName.form-control.text-bg-dark(type="text" name="partyName" required placeholder="Who are you lending to / borrowing from?")
                            .col-md-6
                                label.form-label(for="modalPartyEmail")
                                    i.bi.bi-envelope.me-1
                                    | Email (optional)
                                input#modalPartyEmail.form-control.text-bg-dark(type="email" name="partyEmail" placeholder="For reminders")
                            .col-md-6
                                label.form-label(for="modalPartyPhone")
                                    i.bi.bi-phone.me-1
                                    | Phone (optional)
                                input#modalPartyPhone.form-control.text-bg-dark(type="tel" name="partyPhone")
                            .col-md-12
                                label.form-label(for="modalNotes")
                                    i.bi.bi-sticky.me-1
                                    | Notes (optional)
                                input#modalNotes.form-control.text-bg-dark(type="text" name="notes" placeholder="Any additional notes about this loan...")
                .modal-footer.border-secondary
                    button.btn.btn-secondary(type="button" data-bs-dismiss="modal") Cancel
                    button.btn.btn-primary(type="submit" form="newLoanForm")
                        i.bi.bi-check-lg.me-1
                        | Create Loan

block scripts
    script(type="module" src="/js/loans/list.gen.js")
    script.
        // Initialize Select2 for item dropdown in modal
        document.addEventListener('DOMContentLoaded', function() {
            if (typeof $ !== 'undefined' && $.fn.select2) {
                $('.select2-item').select2({
                    theme: 'bootstrap-5',
                    dropdownParent: $('#newLoanModal'),
                    placeholder: 'Select an item',
                    width: '100%'
                });
            }
        });
