extends ../layout

block content
    - const items = (data && data.items) ? data.items : []
    - const loans = (data && data.loans) ? data.loans : []
    - const conditions = ['new', 'like_new', 'good', 'fair', 'poor']

    #liveAlerts

    .d-flex.justify-content-between.align-items-center.mb-3
        div
            a.btn.btn-outline-secondary.btn-sm(href="/items") Back
            h1.h3.mt-2.mb-0 Lending
        a.btn.btn-outline-secondary(href="/scan") Scan

    .card.mb-4
        .card-body
            h2.h5.mb-3 New loan
            form.row.g-3(method="post" action="/loans")
                .col-md-4
                    label.form-label(for="itemId") Item
                    select#itemId.form-select(name="itemId" required)
                        option(value="" disabled selected) Select an item...
                        each it in items
                            option(value=it.id) #{it.name}
                .col-md-3
                    label.form-label(for="direction") Type
                    select#direction.form-select(name="direction")
                        option(value="lend" selected) Lending out
                        option(value="borrow") Borrowing
                .col-md-2
                    label.form-label(for="conditionOut") Condition
                    select#conditionOut.form-select(name="conditionOut")
                        option(value="") Not specified
                        each c in conditions
                            option(value=c) #{c.replace('_', ' ')}
                .col-md-3
                    label.form-label(for="partyName") Counterparty (name)
                    input#partyName.form-control(type="text" name="partyName" required)
                .col-md-4
                    label.form-label(for="partyEmail") Email (optional)
                    input#partyEmail.form-control(type="email" name="partyEmail")
                .col-md-4
                    label.form-label(for="partyPhone") Phone (optional)
                    input#partyPhone.form-control(type="tel" name="partyPhone")
                .col-md-4
                    label.form-label(for="dueAt") Due date (optional)
                    input#dueAt.form-control(type="date" name="dueAt")
                .col-12
                    label.form-label(for="notes") Notes (optional)
                    textarea#notes.form-control(name="notes" rows="2" placeholder="Any additional notes about this loan...")
                .col-12
                    button.btn.btn-primary(type="submit") Create loan

    .card
        .card-body
            h2.h5.mb-3 Active loans
            if loans.length === 0
                .text-muted No active loans.
            else
                .table-responsive
                    table.table.table-hover.align-middle
                        thead
                            tr
                                th Item
                                th Type
                                th Counterparty
                                th Condition
                                th Started
                                th Due
                                th
                        tbody
                            each l in loans
                                tr
                                    td
                                        a(href=`/items/${l.item.id}`) #{l.item.name}
                                    td
                                        if l.direction === 'lend'
                                            span.badge.text-bg-primary Lending
                                        else
                                            span.badge.text-bg-secondary Borrowing
                                    td
                                        | #{l.party.name}
                                        if l.party.email
                                            span.text-muted.small  (#{l.party.email})
                                    td.text-muted #{l.conditionOut ? l.conditionOut.replace('_', ' ') : '—'}
                                    td.text-muted #{new Date(l.startAt).toLocaleString()}
                                    td.text-muted #{l.dueAt ? new Date(l.dueAt).toLocaleDateString() : '—'}
                                    td.text-end
                                        button.btn.btn-sm.btn-outline-success.loan-return(type="button" data-loan-id=l.id) Mark returned
            p.text-muted.small.mt-3 Returned loans are kept for audit purposes.

block scripts
    script(type="module" src="/js/loans/list.gen.js")
