extends ../layout

block meta
    title External Accounts | Inventory Management

block content
    - const accounts = (data && data.accounts) ? data.accounts : []
    - const connectors = (data && data.connectors) ? data.connectors : []
    //- Generate provider list from registered connectors
    - const connectorProviders = connectors.map(c => c.provider)

    #liveAlerts

    .d-flex.justify-content-between.align-items-center.mb-3.flex-wrap.gap-2
        h1.h3.mb-0.text-white
            i.bi.bi-cloud.me-2
            | External Accounts
            if accounts.length > 0
                span.badge.text-bg-secondary.ms-2.fs-6 #{accounts.length}
        
        button.btn.btn-primary(type="button" data-bs-toggle="modal" data-bs-target="#addAccountModal")
            i.bi.bi-plus-lg.me-1
            | Link Account

    //- Info card
    .card.text-bg-dark.border-secondary.mb-3
        .card-body
            i.bi.bi-info-circle.me-2
            | Link your gaming accounts to sync your library.
            ul.mb-0.mt-2
                li 
                    strong Automatic import
                    |  - Games are automatically imported with metadata (player counts, multiplayer support, etc.)
                li 
                    strong Automatic copies
                    |  - Digital licenses are created automatically for each synced game
                li 
                    strong Scheduled sync
                    |  - Set up periodic syncs to keep your library up to date
                li 
                    strong No manual mapping
                    |  - Everything is handled automatically

    //- Accounts list
    if accounts.length === 0
        .card.text-bg-dark.border-secondary
            .card-body.text-center.py-5
                i.bi.bi-cloud.display-1.text-white-50.mb-3.d-block
                p.text-white-50.mb-3 No external accounts linked yet.
                button.btn.btn-outline-light(type="button" data-bs-toggle="modal" data-bs-target="#addAccountModal")
                    i.bi.bi-plus-lg.me-1
                    | Link Your First Account
    else
        //- Check which providers have connectors (case-insensitive match)
        - const connectorProviderNames = connectors.map(c => c.provider.toLowerCase())
        - const connectorMap = {}
        each conn in connectors
            - connectorMap[conn.provider.toLowerCase()] = conn
        .row.g-3
            each account in accounts
                - const hasConnector = connectorProviderNames.includes(account.provider.toLowerCase())
                - const connector = connectorMap[account.provider.toLowerCase()]
                - const isPushStyle = connector && connector.syncStyle === 'push'
                - const supportsDevices = connector && connector.supportsDevices
                .col-md-6.col-lg-4
                    .card.text-bg-dark.border-secondary.h-100
                        .card-body
                            .d-flex.justify-content-between.align-items-start.mb-3
                                div
                                    h5.mb-1.text-white
                                        i.bi.bi-cloud.me-2
                                        | #{account.accountName}
                                    span.badge.text-bg-info #{account.provider}
                                    if !hasConnector
                                        span.badge.text-bg-warning.ms-1 Manual
                                    if isPushStyle
                                        span.badge.text-bg-secondary.ms-1 Push
                                    if connector && connector.isAggregator
                                        span.badge.text-bg-primary.ms-1 Aggregator
                                .dropdown
                                    button.btn.btn-sm.btn-outline-secondary.dropdown-toggle(type="button" data-bs-toggle="dropdown")
                                        i.bi.bi-three-dots-vertical
                                    ul.dropdown-menu.dropdown-menu-dark.dropdown-menu-end
                                        li
                                            button.dropdown-item.edit-account-btn(type="button" data-account-id=account.id data-account-name=account.accountName data-external-user-id=account.externalUserId data-provider=account.provider)
                                                i.bi.bi-pencil.me-2
                                                | Edit Account
                                        if supportsDevices
                                            li
                                                button.dropdown-item.manage-devices-btn(type="button" data-account-id=account.id data-account-name=account.accountName)
                                                    i.bi.bi-device-hdd.me-2
                                                    | Manage Devices
                                        if hasConnector && !isPushStyle
                                            li
                                                form(method="post" action=`/games/accounts/${account.id}/sync`)
                                                    button.dropdown-item(type="submit")
                                                        i.bi.bi-arrow-repeat.me-2
                                                        | Sync Now
                                            li
                                                button.dropdown-item(type="button" data-bs-toggle="modal" data-bs-target=`#scheduleModal-${account.id}`)
                                                    i.bi.bi-clock.me-2
                                                    | Schedule Sync
                                            li
                                                form(method="post" action=`/games/accounts/${account.id}/unschedule`)
                                                    button.dropdown-item(type="submit")
                                                        i.bi.bi-clock-history.me-2
                                                        | Cancel Schedule
                                        li
                                            hr.dropdown-divider
                                        li
                                            form(method="post" action=`/games/accounts/${account.id}/delete`)
                                                button.dropdown-item.text-danger(type="submit" onclick="return confirm('Remove this account?')")
                                                    i.bi.bi-trash.me-2
                                                    | Remove
                            
                            .small.text-white-50
                                if !hasConnector
                                    i.bi.bi-info-circle.me-1
                                    | Manual account (no connector) - use to track games without auto-sync
                                else if isPushStyle
                                    i.bi.bi-device-hdd.me-1
                                    | Push-style connector - data is synced from the external agent
                                else if account.lastSyncedAt
                                    i.bi.bi-clock.me-1
                                    | Last synced: #{new Date(account.lastSyncedAt).toLocaleString()}
                                else
                                    i.bi.bi-exclamation-circle.me-1
                                    | Never synced
                            
                            //- Sync status container (updated via JavaScript)
                            if hasConnector && !isPushStyle
                                .sync-status-container.mt-2(data-account-id=account.id)
                                    .sync-status.text-white-50.small
                                        //- Status will be populated by JavaScript

                        .card-footer.bg-transparent.border-secondary
                            if hasConnector && !isPushStyle
                                .d-flex.gap-2
                                    form.flex-grow-1(method="post" action=`/games/accounts/${account.id}/sync`)
                                        button.btn.btn-sm.btn-outline-primary.w-100.sync-btn(type="submit" data-account-id=account.id)
                                            i.bi.bi-arrow-repeat.me-1.sync-icon
                                            | Sync Library
                                    button.btn.btn-sm.btn-outline-secondary.check-status-btn(type="button" data-account-id=account.id)
                                        i.bi.bi-arrow-clockwise.me-1
                                        | Check Status
                            else if supportsDevices
                                button.btn.btn-sm.btn-outline-primary.w-100.manage-devices-btn(type="button" data-account-id=account.id data-account-name=account.accountName)
                                    i.bi.bi-device-hdd.me-1
                                    | Manage Devices
                            else
                                .text-center.text-white-50.small
                                    i.bi.bi-hand-index.me-1
                                    | Link games manually from the copy detail page
                    
                    //- Schedule Modal for this account
                    .modal.fade(id=`scheduleModal-${account.id}` tabindex="-1")
                        .modal-dialog
                            .modal-content.text-bg-dark
                                .modal-header.border-secondary
                                    h5.modal-title
                                        i.bi.bi-clock.me-2
                                        | Schedule Periodic Sync
                                    button.btn-close.btn-close-white(type="button" data-bs-dismiss="modal")
                                .modal-body
                                    form(id=`scheduleForm-${account.id}` method="post" action=`/games/accounts/${account.id}/schedule`)
                                        label.form-label Sync Interval
                                        select.form-select.text-bg-dark(name="intervalMinutes" required)
                                            option(value="60") Every hour
                                            option(value="360") Every 6 hours
                                            option(value="720") Every 12 hours
                                            option(value="1440" selected) Daily
                                            option(value="10080") Weekly
                                        .form-text.text-white-50 Automatically sync your library at regular intervals.
                                .modal-footer.border-secondary
                                    button.btn.btn-secondary(type="button" data-bs-dismiss="modal") Cancel
                                    button.btn.btn-primary(type="submit" form=`scheduleForm-${account.id}`)
                                        i.bi.bi-check-lg.me-1
                                        | Enable Schedule

    //- Available connectors
    .card.text-bg-dark.border-secondary.mt-4
        .card-header
            h5.mb-0
                i.bi.bi-plug.me-2
                | Available Connectors
        .card-body
            if connectors.length === 0
                p.text-white-50.mb-0 No connectors available.
            else
                .row.g-2
                    each conn in connectors
                        .col-md-6.col-lg-4
                            .card.text-bg-dark.border-secondary
                                .card-body.py-2
                                    .d-flex.justify-content-between.align-items-start
                                        div
                                            h6.mb-1 #{conn.name}
                                            if conn.syncStyle === 'push'
                                                span.badge.text-bg-secondary.small.me-1 Push
                                            else
                                                span.badge.text-bg-primary.small.me-1 Fetch
                                            if conn.isAggregator
                                                span.badge.text-bg-info.small.me-1 Aggregator
                                    p.small.text-white-50.mb-1 #{conn.description}
                                    .d-flex.flex-wrap.gap-1
                                        each cap in conn.capabilities
                                            span.badge.text-bg-dark.small.border.border-secondary #{cap.replace('_', ' ')}

    //- Edit Account Modal
    #editAccountModal.modal.fade(tabindex="-1")
        .modal-dialog
            .modal-content.text-bg-dark
                .modal-header.border-secondary
                    h5.modal-title
                        i.bi.bi-pencil.me-2
                        | Edit Account
                    button.btn-close.btn-close-white(type="button" data-bs-dismiss="modal")
                .modal-body
                    form#editAccountForm.row.g-3
                        input#editAccountId(type="hidden" name="accountId")
                        .col-12
                            label.form-label Account Name *
                            input#editAccountName.form-control.text-bg-dark(type="text" name="accountName" required)
                        .col-12#editExternalUserIdField
                            label.form-label.edit-field-label User ID / External ID
                            input#editExternalUserId.form-control.text-bg-dark(type="text" name="externalUserId")
                .modal-footer.border-secondary
                    button.btn.btn-secondary(type="button" data-bs-dismiss="modal") Cancel
                    button.btn.btn-primary(type="submit" form="editAccountForm")
                        i.bi.bi-check-lg.me-1
                        | Save Changes

    //- Manage Devices Modal (for push-style connectors)
    #manageDevicesModal.modal.fade(tabindex="-1")
        .modal-dialog.modal-lg
            .modal-content.text-bg-dark
                .modal-header.border-secondary
                    h5.modal-title
                        i.bi.bi-device-hdd.me-2
                        span#devicesModalTitle Manage Devices
                    button.btn-close.btn-close-white(type="button" data-bs-dismiss="modal")
                .modal-body
                    input#devicesAccountId(type="hidden")
                    .alert.alert-info.mb-3
                        i.bi.bi-info-circle.me-2
                        | Devices allow external agents to push data to this account. Register a device to get a token for the agent.
                    
                    //- Device registration form
                    form#registerDeviceForm.mb-4
                        .row.g-2.align-items-end
                            .col-md-8
                                label.form-label Device Name
                                input#deviceNameInput.form-control.text-bg-dark(type="text" name="deviceName" placeholder="e.g., Gaming PC" required)
                            .col-md-4
                                button.btn.btn-primary.w-100(type="submit")
                                    i.bi.bi-plus-lg.me-1
                                    | Register Device
                    
                    //- Device list container (populated by JavaScript)
                    #devicesList
                        .text-center.py-4
                            .spinner-border.text-primary(role="status")
                                span.visually-hidden Loading...
                    
                    .mt-4
                        h6.text-white-50
                            i.bi.bi-question-circle.me-1
                            | How to use
                        ol.small.text-white-50
                            li Register a device above and copy the token
                            li Install and configure the agent for your platform
                            li Use the token to authenticate the agent
                            li The agent will push library data to this account
                .modal-footer.border-secondary
                    button.btn.btn-secondary(type="button" data-bs-dismiss="modal") Close

    //- Add Account Modal
    #addAccountModal.modal.fade(tabindex="-1")
        .modal-dialog
            .modal-content.text-bg-dark
                .modal-header.border-secondary
                    h5.modal-title
                        i.bi.bi-plus-circle.me-2
                        | Link External Account
                    button.btn-close.btn-close-white(type="button" data-bs-dismiss="modal")
                .modal-body
                    //- Provider list generated from registered connectors
                    form#addAccountForm.row.g-3(method="post" action="/games/accounts")
                        .col-12
                            label.form-label Provider *
                            select#providerSelect.form-select.text-bg-dark(name="provider" required)
                                //- Options from registered connectors
                                each conn in connectors
                                    option(value=conn.provider data-sync-style=conn.syncStyle data-credential-fields=JSON.stringify(conn.credentialFields || []) selected=(conn === connectors[0])) #{conn.name}
                                option(value="Other" data-sync-style="none" data-credential-fields="[]") Other (Manual only)
                        
                        //- Custom provider name (only visible when "Other" selected)
                        #customProviderField.col-12.d-none
                            label.form-label Custom Provider Name *
                            input#customProviderInput.form-control.text-bg-dark(type="text" placeholder="e.g., My Custom Store")
                            .form-text.text-white-50 No connector available. Games must be added manually.
                        
                        .col-12
                            label.form-label Account Name *
                            input#addAccountName.form-control.text-bg-dark(type="text" name="accountName" required placeholder="e.g., My Steam Account")
                        
                        //- Dynamic credential fields container (populated by JavaScript)
                        #credentialFieldsContainer
                        
                        //- Push-style connector notice
                        #pushConnectorNotice.col-12.d-none
                            .alert.alert-info.mb-0
                                i.bi.bi-device-hdd.me-2
                                strong Push-style Connector:
                                |  After creating this account, register a device to enable data sync. The device token will be used to authenticate imports.
                        
                        //- Manual account notice (only visible when "Other" selected)
                        #manualAccountNotice.col-12.d-none
                            .alert.alert-warning.mb-0
                                i.bi.bi-hand-index.me-2
                                strong Manual Account:
                                |  No automatic sync available. You can manually link games to this account from the copy detail page.
                .modal-footer.border-secondary
                    button.btn.btn-secondary(type="button" data-bs-dismiss="modal") Cancel
                    button.btn.btn-primary(type="submit" form="addAccountForm")
                        i.bi.bi-link-45deg.me-1
                        | Link Account

block scripts
    script.
        // Store connector data for JavaScript access (sanitized via JSON.stringify)
        // JSON.stringify escapes special characters like < > & ' " which prevents XSS
        // Additional protection: only serialize known safe properties
        const connectorsData = !{JSON.stringify(connectors.map(c => ({
            id: c.id,
            name: c.name,
            description: c.description,
            provider: c.provider,
            syncStyle: c.syncStyle,
            isAggregator: c.isAggregator,
            supportsDevices: c.supportsDevices,
            credentialFields: c.credentialFields
        })))};
        const connectorMap = {};
        connectorsData.forEach(c => {
            connectorMap[c.provider] = c;
        });
        
        document.addEventListener('DOMContentLoaded', function() {
            const providerSelect = document.getElementById('providerSelect');
            const customProviderField = document.getElementById('customProviderField');
            const customProviderInput = document.getElementById('customProviderInput');
            const credentialFieldsContainer = document.getElementById('credentialFieldsContainer');
            const pushConnectorNotice = document.getElementById('pushConnectorNotice');
            const manualAccountNotice = document.getElementById('manualAccountNotice');
            const addAccountForm = document.getElementById('addAccountForm');
            
            // Function to generate credential fields dynamically
            function renderCredentialFields(provider) {
                // Clear previous fields
                credentialFieldsContainer.innerHTML = '';
                pushConnectorNotice.classList.add('d-none');
                manualAccountNotice.classList.add('d-none');
                customProviderField.classList.add('d-none');
                
                if (provider === 'Other') {
                    customProviderField.classList.remove('d-none');
                    manualAccountNotice.classList.remove('d-none');
                    customProviderInput.required = true;
                    return;
                }
                
                customProviderInput.required = false;
                
                const connector = connectorMap[provider];
                if (!connector) {
                    return;
                }
                
                // For push-style connectors, show notice instead of credential fields
                if (connector.syncStyle === 'push') {
                    pushConnectorNotice.classList.remove('d-none');
                    return;
                }
                
                // Render credential fields for fetch-style connectors
                const fields = connector.credentialFields || [];
                if (fields.length === 0) {
                    // Default fields if none specified
                    credentialFieldsContainer.innerHTML = `
                        <div class="col-12">
                            <label class="form-label">User ID / External ID</label>
                            <input class="form-control text-bg-dark" type="text" name="externalUserId" placeholder="Your external user ID">
                        </div>
                        <div class="col-12 mt-2">
                            <label class="form-label">API Key / Token (optional)</label>
                            <input class="form-control text-bg-dark" type="password" name="tokenRef" placeholder="API key or token if required">
                            <div class="form-text text-white-50">This will be stored securely and used for syncing.</div>
                        </div>
                    `;
                    return;
                }
                
                // Map field.mapsTo to actual input name
                const fieldNameMap = {
                    'externalUserId': 'externalUserId',
                    'tokenRef': 'tokenRef'
                };
                
                // Generate fields from schema
                fields.forEach((field, index) => {
                    const fieldHtml = document.createElement('div');
                    fieldHtml.className = 'col-12' + (index > 0 ? ' mt-2' : '');
                    
                    const labelHtml = `<label class="form-label">${field.label}${field.required ? ' *' : ''}</label>`;
                    const inputType = field.type || 'text';
                    const inputName = fieldNameMap[field.mapsTo] || field.name;
                    const requiredAttr = field.required ? 'required' : '';
                    const placeholderAttr = field.placeholder ? `placeholder="${field.placeholder}"` : '';
                    const inputHtml = `<input class="form-control text-bg-dark" type="${inputType}" name="${inputName}" ${requiredAttr} ${placeholderAttr}>`;
                    const helpHtml = field.helpText ? `<div class="form-text text-white-50">${field.helpText}</div>` : '';
                    
                    fieldHtml.innerHTML = labelHtml + inputHtml + helpHtml;
                    credentialFieldsContainer.appendChild(fieldHtml);
                });
            }
            
            if (providerSelect) {
                // Initial render for default selection
                renderCredentialFields(providerSelect.value);
                
                providerSelect.addEventListener('change', function() {
                    renderCredentialFields(this.value);
                });
                
                // On form submit, if "Other" is selected, use custom provider name
                addAccountForm.addEventListener('submit', function(e) {
                    if (providerSelect.value === 'Other') {
                        // Replace the select value with custom provider input
                        providerSelect.name = '';
                        const hiddenInput = document.createElement('input');
                        hiddenInput.type = 'hidden';
                        hiddenInput.name = 'provider';
                        hiddenInput.value = customProviderInput.value.trim() || 'Other';
                        addAccountForm.appendChild(hiddenInput);
                    }
                });
            }
            
            // Check sync status on page load for all accounts
            const statusContainers = document.querySelectorAll('.sync-status-container');
            statusContainers.forEach(container => {
                const accountId = container.dataset.accountId;
                if (accountId) {
                    checkSyncStatus(accountId);
                }
            });
            
            // Add event listeners for check status buttons
            document.querySelectorAll('.check-status-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const accountId = this.dataset.accountId;
                    if (accountId && isValidUUID(accountId)) {
                        checkSyncStatus(accountId);
                    }
                });
            });
        });
        
        // Validate that a string is a valid UUID format
        function isValidUUID(str) {
            const uuidRegex = /^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i;
            return uuidRegex.test(str);
        }
        
        // Track accounts being polled
        const pollingIntervals = {};
        
        // Check sync status for an account
        async function checkSyncStatus(accountId) {
            // Validate accountId format to prevent path traversal
            if (!accountId || !isValidUUID(accountId)) {
                console.error('Invalid account ID format');
                return;
            }
            
            try {
                const response = await fetch(`/games/accounts/${encodeURIComponent(accountId)}/status`);
                if (!response.ok) return;
                
                const status = await response.json();
                updateSyncStatusUI(accountId, status);
                
                // If sync is in progress, start polling
                if (status.latestJob && status.latestJob.status === 'in_progress') {
                    startPolling(accountId);
                } else {
                    stopPolling(accountId);
                }
            } catch (err) {
                console.error('Failed to check sync status:', err);
            }
        }
        
        // Update the UI with sync status
        function updateSyncStatusUI(accountId, status) {
            const container = document.querySelector(`.sync-status-container[data-account-id="${accountId}"]`);
            if (!container) return;
            
            const statusDiv = container.querySelector('.sync-status');
            const syncBtn = document.querySelector(`.sync-btn[data-account-id="${accountId}"]`);
            const syncIcon = syncBtn?.querySelector('.sync-icon');
            
            if (!status.latestJob) {
                statusDiv.innerHTML = '';
                return;
            }
            
            const job = status.latestJob;
            let html = '';
            let spinIcon = false;
            
            switch (job.status) {
                case 'pending':
                    html = '<i class="bi bi-hourglass-start me-1"></i>Sync pending...';
                    spinIcon = true;
                    break;
                case 'in_progress':
                    html = '<i class="bi bi-arrow-repeat me-1 sync-spin"></i>Sync in progress...';
                    if (job.entriesProcessed !== null) {
                        html += ` (${job.entriesProcessed} games processed)`;
                    }
                    spinIcon = true;
                    break;
                case 'completed':
                    html = `<i class="bi bi-check-circle me-1 text-success"></i>`;
                    html += `Completed: ${job.entriesProcessed || 0} games`;
                    break;
                case 'failed':
                    html = `<i class="bi bi-x-circle me-1 text-danger"></i>`;
                    html += `Failed: ${job.errorMessage || 'Unknown error'}`;
                    break;
            }
            
            statusDiv.innerHTML = html;
            
            // Add/remove spinning animation on sync button
            if (syncIcon) {
                if (spinIcon) {
                    syncIcon.classList.add('sync-spin');
                    if (syncBtn) syncBtn.disabled = true;
                } else {
                    syncIcon.classList.remove('sync-spin');
                    if (syncBtn) syncBtn.disabled = false;
                }
            }
        }
        
        // Start polling for sync status
        function startPolling(accountId) {
            if (pollingIntervals[accountId]) return; // Already polling
            
            pollingIntervals[accountId] = setInterval(() => {
                checkSyncStatus(accountId);
            }, 3000); // Poll every 3 seconds
        }
        
        // Stop polling for sync status
        function stopPolling(accountId) {
            if (pollingIntervals[accountId]) {
                clearInterval(pollingIntervals[accountId]);
                delete pollingIntervals[accountId];
            }
        }
        
        // ============ Edit Account Modal ============
        document.querySelectorAll('.edit-account-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                const accountId = this.dataset.accountId;
                const accountName = this.dataset.accountName;
                const externalUserId = this.dataset.externalUserId || '';
                
                document.getElementById('editAccountId').value = accountId;
                document.getElementById('editAccountName').value = accountName;
                document.getElementById('editExternalUserId').value = externalUserId;
                
                const modal = new bootstrap.Modal(document.getElementById('editAccountModal'));
                modal.show();
            });
        });
        
        // Handle edit account form submission
        const editAccountForm = document.getElementById('editAccountForm');
        if (editAccountForm) {
            editAccountForm.addEventListener('submit', async function(e) {
                e.preventDefault();
                
                const accountId = document.getElementById('editAccountId').value;
                const accountName = document.getElementById('editAccountName').value.trim();
                const externalUserId = document.getElementById('editExternalUserId').value.trim();
                
                if (!accountId || !accountName) return;
                
                try {
                    const response = await fetch(`/api/accounts/${encodeURIComponent(accountId)}`, {
                        method: 'PATCH',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({accountName, externalUserId: externalUserId || null})
                    });
                    
                    if (response.ok) {
                        location.reload();
                    } else {
                        const data = await response.json();
                        showAlert(data.message || 'Failed to update account', 'danger');
                    }
                } catch (err) {
                    console.error('Failed to update account:', err);
                    showAlert('Failed to update account. Please try again.', 'danger');
                }
            });
        }
        
        // ============ Manage Devices Modal ============
        let currentDevicesAccountId = null;
        
        document.querySelectorAll('.manage-devices-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                currentDevicesAccountId = this.dataset.accountId;
                const accountName = this.dataset.accountName;
                
                document.getElementById('devicesAccountId').value = currentDevicesAccountId;
                document.getElementById('devicesModalTitle').textContent = `Devices for ${accountName}`;
                
                loadDevices(currentDevicesAccountId);
                
                const modal = new bootstrap.Modal(document.getElementById('manageDevicesModal'));
                modal.show();
            });
        });
        
        // Load devices for an account
        async function loadDevices(accountId) {
            const container = document.getElementById('devicesList');
            container.innerHTML = '<div class="text-center py-4"><div class="spinner-border text-primary" role="status"><span class="visually-hidden">Loading...</span></div></div>';
            
            try {
                const response = await fetch(`/api/accounts/${encodeURIComponent(accountId)}/devices`);
                const data = await response.json();
                
                if (response.ok) {
                    renderDevicesList(data.devices, accountId);
                } else {
                    container.innerHTML = `<div class="alert alert-danger">${data.message || 'Failed to load devices'}</div>`;
                }
            } catch (err) {
                console.error('Failed to load devices:', err);
                container.innerHTML = '<div class="alert alert-danger">Failed to load devices. Please try again.</div>';
            }
        }
        
        // Render devices list
        function renderDevicesList(devices, accountId) {
            const container = document.getElementById('devicesList');
            
            if (!devices || devices.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-4">
                        <i class="bi bi-device-hdd display-4 text-white-50 d-block mb-3"></i>
                        <p class="text-white-50">No devices registered yet.</p>
                        <p class="small text-white-50">Register a device above to get a token.</p>
                    </div>
                `;
                return;
            }
            
            let html = `
                <div class="table-responsive">
                    <table class="table table-dark table-hover mb-0">
                        <thead>
                            <tr>
                                <th>Device Name</th>
                                <th>Status</th>
                                <th>Last Seen</th>
                                <th>Last Import</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
            `;
            
            devices.forEach(device => {
                const statusBadge = device.status === 'active' 
                    ? '<span class="badge text-bg-success">Active</span>'
                    : '<span class="badge text-bg-danger">Revoked</span>';
                const lastSeen = device.lastSeenAt ? new Date(device.lastSeenAt).toLocaleDateString() : '<span class="text-white-50">Never</span>';
                const lastImport = device.lastImportAt ? new Date(device.lastImportAt).toLocaleDateString() : '<span class="text-white-50">Never</span>';
                
                html += `
                    <tr>
                        <td>${device.name}</td>
                        <td>${statusBadge}</td>
                        <td>${lastSeen}</td>
                        <td>${lastImport}</td>
                        <td>
                            ${device.status === 'active' ? `
                                <button class="btn btn-sm btn-outline-warning revoke-device-btn" data-device-id="${device.id}">
                                    <i class="bi bi-x-circle me-1"></i>Revoke
                                </button>
                            ` : ''}
                        </td>
                    </tr>
                `;
            });
            
            html += '</tbody></table></div>';
            container.innerHTML = html;
            
            // Add event listeners for revoke buttons
            container.querySelectorAll('.revoke-device-btn').forEach(btn => {
                btn.addEventListener('click', async function() {
                    const deviceId = this.dataset.deviceId;
                    if (!confirm('Revoke this device? You will need to register a new device.')) return;
                    
                    try {
                        const response = await fetch(`/api/accounts/${encodeURIComponent(accountId)}/devices/${encodeURIComponent(deviceId)}/revoke`, {
                            method: 'POST'
                        });
                        
                        if (response.ok) {
                            loadDevices(accountId);
                        } else {
                            const data = await response.json();
                            showAlert(data.message || 'Failed to revoke device', 'danger');
                        }
                    } catch (err) {
                        console.error('Failed to revoke device:', err);
                        showAlert('Failed to revoke device. Please try again.', 'danger');
                    }
                });
            });
        }
        
        // Handle device registration form
        const registerDeviceForm = document.getElementById('registerDeviceForm');
        if (registerDeviceForm) {
            registerDeviceForm.addEventListener('submit', async function(e) {
                e.preventDefault();
                
                const accountId = document.getElementById('devicesAccountId').value;
                const deviceNameInput = document.getElementById('deviceNameInput');
                const deviceName = deviceNameInput.value.trim();
                
                if (!accountId || !deviceName) return;
                
                try {
                    const response = await fetch(`/api/accounts/${encodeURIComponent(accountId)}/devices`, {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({deviceName})
                    });
                    
                    const data = await response.json();
                    
                    if (response.ok && data.token) {
                        // Show the token to the user
                        const tokenModal = document.createElement('div');
                        tokenModal.innerHTML = `
                            <div class="modal fade" id="tokenResultModal" tabindex="-1">
                                <div class="modal-dialog">
                                    <div class="modal-content text-bg-dark">
                                        <div class="modal-header border-secondary">
                                            <h5 class="modal-title"><i class="bi bi-key me-2"></i>Device Token</h5>
                                            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                                        </div>
                                        <div class="modal-body">
                                            <div class="alert alert-warning">
                                                <i class="bi bi-exclamation-triangle me-2"></i>
                                                <strong>Save this token now!</strong> It will not be shown again.
                                            </div>
                                            <label class="form-label">Device ID</label>
                                            <input type="text" class="form-control text-bg-dark mb-3" value="${data.deviceId}" readonly>
                                            <label class="form-label">Token</label>
                                            <div class="input-group">
                                                <input type="text" class="form-control text-bg-dark" id="deviceToken" value="${data.token}" readonly>
                                                <button class="btn btn-outline-secondary" type="button" onclick="navigator.clipboard.writeText(document.getElementById('deviceToken').value).then(() => this.innerHTML = '<i class=\\'bi bi-check\\'></i>')">
                                                    <i class="bi bi-clipboard"></i>
                                                </button>
                                            </div>
                                            <p class="small text-white-50 mt-2">Use this token with your sync agent.</p>
                                        </div>
                                        <div class="modal-footer border-secondary">
                                            <button type="button" class="btn btn-primary" data-bs-dismiss="modal" onclick="loadDevices('${accountId}')">Done</button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        `;
                        document.body.appendChild(tokenModal);
                        const modal = new bootstrap.Modal(document.getElementById('tokenResultModal'));
                        modal.show();
                        
                        // Clear input
                        deviceNameInput.value = '';
                    } else {
                        showAlert(data.message || 'Failed to register device', 'danger');
                    }
                } catch (err) {
                    console.error('Failed to register device:', err);
                    showAlert('Failed to register device. Please try again.', 'danger');
                }
            });
        }
        
        // Show alert in the liveAlerts container
        function showAlert(message, type = 'danger') {
            const alertsContainer = document.getElementById('liveAlerts');
            if (alertsContainer) {
                const alertDiv = document.createElement('div');
                alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
                alertDiv.innerHTML = `
                    <i class="bi bi-${type === 'danger' ? 'exclamation-triangle' : 'check-circle'} me-2"></i>
                    ${message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                `;
                alertsContainer.appendChild(alertDiv);
                
                // Auto-dismiss after 5 seconds
                setTimeout(() => {
                    alertDiv.remove();
                }, 5000);
            }
        }
    
    style.
        .sync-spin {
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
