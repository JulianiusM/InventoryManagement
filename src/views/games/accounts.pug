extends ../layout

block meta
    title External Accounts | Inventory Management

block content
    - const accounts = (data && data.accounts) ? data.accounts : []
    - const connectors = (data && data.connectors) ? data.connectors : []
    //- Generate provider list from registered connectors
    - const connectorProviders = connectors.map(c => c.provider)
    //- Serialize connector data for TypeScript module
    - const safeConnectorData = JSON.stringify(connectors.map(c => ({id: c.id, name: c.name, description: c.description, provider: c.provider, syncStyle: c.syncStyle, isAggregator: c.isAggregator, supportsDevices: c.supportsDevices, credentialFields: c.credentialFields})))

    //- Hidden element containing connector data for TypeScript module
    script#connectorData(type="application/json") !{safeConnectorData}

    #liveAlerts

    .d-flex.justify-content-between.align-items-center.mb-3.flex-wrap.gap-2
        h1.h3.mb-0.text-white
            i.bi.bi-cloud.me-2
            | External Accounts
            if accounts.length > 0
                span.badge.text-bg-secondary.ms-2.fs-6 #{accounts.length}
        
        .btn-group
            a.btn.btn-outline-light(href="/games/jobs")
                i.bi.bi-clock-history.me-1
                | View Jobs
            button.btn.btn-primary(type="button" data-bs-toggle="modal" data-bs-target="#addAccountModal")
                i.bi.bi-plus-lg.me-1
                | Link Account

    //- Info card
    .card.text-bg-dark.border-secondary.mb-3
        .card-body
            i.bi.bi-info-circle.me-2
            | Link your gaming accounts to sync your library.
            ul.mb-0.mt-2
                li 
                    strong Automatic import
                    |  - Games are automatically imported with metadata (player counts, multiplayer support, etc.)
                li 
                    strong Automatic copies
                    |  - Digital licenses are created automatically for each synced game
                li 
                    strong Scheduled sync
                    |  - Set up periodic syncs to keep your library up to date
                li 
                    strong No manual mapping
                    |  - Everything is handled automatically

    //- Accounts list
    if accounts.length === 0
        .card.text-bg-dark.border-secondary
            .card-body.text-center.py-5
                i.bi.bi-cloud.display-1.text-white-50.mb-3.d-block
                p.text-white-50.mb-3 No external accounts linked yet.
                button.btn.btn-outline-light(type="button" data-bs-toggle="modal" data-bs-target="#addAccountModal")
                    i.bi.bi-plus-lg.me-1
                    | Link Your First Account
    else
        //- Check which providers have connectors (case-insensitive match)
        - const connectorProviderNames = connectors.map(c => c.provider.toLowerCase())
        - const connectorMap = {}
        each conn in connectors
            - connectorMap[conn.provider.toLowerCase()] = conn
        .row.g-3
            each account in accounts
                - const hasConnector = connectorProviderNames.includes(account.provider.toLowerCase())
                - const connector = connectorMap[account.provider.toLowerCase()]
                - const isPushStyle = connector && connector.syncStyle === 'push'
                - const supportsDevices = connector && connector.supportsDevices
                .col-md-6.col-lg-4
                    .card.text-bg-dark.border-secondary.h-100
                        .card-body
                            .d-flex.justify-content-between.align-items-start.mb-3
                                div
                                    h5.mb-1.text-white
                                        i.bi.bi-cloud.me-2
                                        | #{account.accountName}
                                    .d-flex.flex-wrap.gap-1.align-items-center
                                        span.badge.text-bg-info #{account.provider}
                                        if !hasConnector
                                            span.badge.text-bg-warning Manual
                                        if isPushStyle
                                            span.badge.text-bg-secondary Push
                                        if connector && connector.isAggregator
                                            span.badge.text-bg-primary Aggregator
                                .dropdown
                                    button.btn.btn-sm.btn-outline-secondary.dropdown-toggle(type="button" data-bs-toggle="dropdown")
                                        i.bi.bi-three-dots-vertical
                                    ul.dropdown-menu.dropdown-menu-dark.dropdown-menu-end
                                        li
                                            button.dropdown-item.edit-account-btn(type="button" data-account-id=account.id data-account-name=account.accountName data-external-user-id=account.externalUserId data-provider=account.provider)
                                                i.bi.bi-pencil.me-2
                                                | Edit Account
                                        if supportsDevices
                                            li
                                                button.dropdown-item.manage-devices-btn(type="button" data-account-id=account.id data-account-name=account.accountName)
                                                    i.bi.bi-device-hdd.me-2
                                                    | Manage Devices
                                        if hasConnector && !isPushStyle
                                            li
                                                form(method="post" action=`/games/accounts/${account.id}/sync`)
                                                    button.dropdown-item(type="submit")
                                                        i.bi.bi-arrow-repeat.me-2
                                                        | Sync Now
                                            li
                                                button.dropdown-item(type="button" data-bs-toggle="modal" data-bs-target=`#scheduleModal-${account.id}`)
                                                    i.bi.bi-clock.me-2
                                                    | Schedule Sync
                                            li
                                                form(method="post" action=`/games/accounts/${account.id}/unschedule`)
                                                    button.dropdown-item(type="submit")
                                                        i.bi.bi-clock-history.me-2
                                                        | Cancel Schedule
                                        li
                                            hr.dropdown-divider
                                        li
                                            form(method="post" action=`/games/accounts/${account.id}/delete`)
                                                button.dropdown-item.text-danger(type="submit" onclick="return confirm('Remove this account?')")
                                                    i.bi.bi-trash.me-2
                                                    | Remove
                            
                            .small.text-white-50
                                if !hasConnector
                                    i.bi.bi-info-circle.me-1
                                    | Manual account (no connector) - use to track games without auto-sync
                                else if isPushStyle
                                    i.bi.bi-device-hdd.me-1
                                    | Push-style connector - data is synced from the external agent
                                else if account.lastSyncedAt
                                    i.bi.bi-clock.me-1
                                    | Last synced: #{new Date(account.lastSyncedAt).toLocaleString()}
                                else
                                    i.bi.bi-exclamation-circle.me-1
                                    | Never synced
                            
                            //- Sync status container (updated via JavaScript)
                            if hasConnector && !isPushStyle
                                .sync-status-container.mt-2(data-account-id=account.id)
                                    .sync-status.text-white-50.small
                                        //- Status will be populated by JavaScript

                        .card-footer.bg-transparent.border-secondary
                            if hasConnector && !isPushStyle
                                .d-flex.gap-2
                                    form.flex-grow-1(method="post" action=`/games/accounts/${account.id}/sync`)
                                        button.btn.btn-sm.btn-outline-primary.w-100.sync-btn(type="submit" data-account-id=account.id)
                                            i.bi.bi-arrow-repeat.me-1.sync-icon
                                            | Sync Library
                                    button.btn.btn-sm.btn-outline-secondary.check-status-btn(type="button" data-account-id=account.id)
                                        i.bi.bi-arrow-clockwise.me-1
                                        | Check Status
                            else if supportsDevices
                                button.btn.btn-sm.btn-outline-primary.w-100.manage-devices-btn(type="button" data-account-id=account.id data-account-name=account.accountName)
                                    i.bi.bi-device-hdd.me-1
                                    | Manage Devices
                            else
                                .text-center.text-white-50.small
                                    i.bi.bi-hand-index.me-1
                                    | Link games manually from the copy detail page
                    
                    //- Schedule Modal for this account
                    .modal.fade(id=`scheduleModal-${account.id}` tabindex="-1")
                        .modal-dialog
                            .modal-content.text-bg-dark
                                .modal-header.border-secondary
                                    h5.modal-title
                                        i.bi.bi-clock.me-2
                                        | Schedule Periodic Sync
                                    button.btn-close.btn-close-white(type="button" data-bs-dismiss="modal")
                                .modal-body
                                    form(id=`scheduleForm-${account.id}` method="post" action=`/games/accounts/${account.id}/schedule`)
                                        label.form-label Sync Interval
                                        select.form-select.text-bg-dark(name="intervalMinutes" required)
                                            option(value="60") Every hour
                                            option(value="360") Every 6 hours
                                            option(value="720") Every 12 hours
                                            option(value="1440" selected) Daily
                                            option(value="10080") Weekly
                                        .form-text.text-white-50 Automatically sync your library at regular intervals.
                                .modal-footer.border-secondary
                                    button.btn.btn-secondary(type="button" data-bs-dismiss="modal") Cancel
                                    button.btn.btn-primary(type="submit" form=`scheduleForm-${account.id}`)
                                        i.bi.bi-check-lg.me-1
                                        | Enable Schedule

    //- Available connectors
    .card.text-bg-dark.border-secondary.mt-4
        .card-header
            h5.mb-0
                i.bi.bi-plug.me-2
                | Available Connectors
        .card-body
            if connectors.length === 0
                p.text-white-50.mb-0 No connectors available.
            else
                .row.g-2
                    each conn in connectors
                        .col-md-6.col-lg-4
                            .card.text-bg-dark.border-secondary
                                .card-body.py-2
                                    .d-flex.justify-content-between.align-items-start
                                        div
                                            h6.mb-1 #{conn.name}
                                            if conn.syncStyle === 'push'
                                                span.badge.text-bg-secondary.small.me-1 Push
                                            else
                                                span.badge.text-bg-primary.small.me-1 Fetch
                                            if conn.isAggregator
                                                span.badge.text-bg-info.small.me-1 Aggregator
                                    p.small.text-white-50.mb-1 #{conn.description}
                                    .d-flex.flex-wrap.gap-1
                                        each cap in conn.capabilities
                                            span.badge.text-bg-dark.small.border.border-secondary #{cap.replace('_', ' ')}

    //- Edit Account Modal
    #editAccountModal.modal.fade(tabindex="-1")
        .modal-dialog
            .modal-content.text-bg-dark
                .modal-header.border-secondary
                    h5.modal-title
                        i.bi.bi-pencil.me-2
                        | Edit Account
                    button.btn-close.btn-close-white(type="button" data-bs-dismiss="modal")
                .modal-body
                    form#editAccountForm.row.g-3
                        input#editAccountId(type="hidden" name="accountId")
                        .col-12
                            label.form-label Account Name *
                            input#editAccountName.form-control.text-bg-dark(type="text" name="accountName" required)
                        .col-12#editExternalUserIdField
                            label.form-label.edit-field-label User ID / External ID
                            input#editExternalUserId.form-control.text-bg-dark(type="text" name="externalUserId")
                .modal-footer.border-secondary
                    button.btn.btn-secondary(type="button" data-bs-dismiss="modal") Cancel
                    button.btn.btn-primary(type="submit" form="editAccountForm")
                        i.bi.bi-check-lg.me-1
                        | Save Changes

    //- Manage Devices Modal (for push-style connectors)
    #manageDevicesModal.modal.fade(tabindex="-1")
        .modal-dialog.modal-lg
            .modal-content.text-bg-dark
                .modal-header.border-secondary
                    h5.modal-title
                        i.bi.bi-device-hdd.me-2
                        span#devicesModalTitle Manage Devices
                    button.btn-close.btn-close-white(type="button" data-bs-dismiss="modal")
                .modal-body
                    input#devicesAccountId(type="hidden")
                    .alert.alert-info.mb-3
                        i.bi.bi-info-circle.me-2
                        | Devices allow external agents to push data to this account. Register a device to get a token for the agent.
                    
                    //- Device registration form
                    form#registerDeviceForm.mb-4
                        .row.g-2.align-items-end
                            .col-md-8
                                label.form-label Device Name
                                input#deviceNameInput.form-control.text-bg-dark(type="text" name="deviceName" placeholder="e.g., Gaming PC" required)
                            .col-md-4
                                button.btn.btn-primary.w-100(type="submit")
                                    i.bi.bi-plus-lg.me-1
                                    | Register Device
                    
                    //- Device list container (populated by JavaScript)
                    #devicesList
                        .text-center.py-4
                            .spinner-border.text-primary(role="status")
                                span.visually-hidden Loading...
                    
                    .mt-4
                        h6.text-white-50
                            i.bi.bi-question-circle.me-1
                            | How to use
                        ol.small.text-white-50
                            li Register a device above and copy the token
                            li Install and configure the agent for your platform
                            li Use the token to authenticate the agent
                            li The agent will push library data to this account
                .modal-footer.border-secondary
                    button.btn.btn-secondary(type="button" data-bs-dismiss="modal") Close

    //- Add Account Modal
    #addAccountModal.modal.fade(tabindex="-1")
        .modal-dialog
            .modal-content.text-bg-dark
                .modal-header.border-secondary
                    h5.modal-title
                        i.bi.bi-plus-circle.me-2
                        | Link External Account
                    button.btn-close.btn-close-white(type="button" data-bs-dismiss="modal")
                .modal-body
                    //- Provider list generated from registered connectors
                    form#addAccountForm.row.g-3(method="post" action="/games/accounts")
                        .col-12
                            label.form-label Provider *
                            select#providerSelect.form-select.text-bg-dark(name="provider" required)
                                //- Options from registered connectors
                                each conn in connectors
                                    option(value=conn.provider data-sync-style=conn.syncStyle data-credential-fields=JSON.stringify(conn.credentialFields || []) selected=(conn === connectors[0])) #{conn.name}
                                option(value="Other" data-sync-style="none" data-credential-fields="[]") Other (Manual only)
                        
                        //- Custom provider name (only visible when "Other" selected)
                        #customProviderField.col-12.d-none
                            label.form-label Custom Provider Name *
                            input#customProviderInput.form-control.text-bg-dark(type="text" placeholder="e.g., My Custom Store")
                            .form-text.text-white-50 No connector available. Games must be added manually.
                        
                        .col-12
                            label.form-label Account Name *
                            input#addAccountName.form-control.text-bg-dark(type="text" name="accountName" required placeholder="e.g., My Steam Account")
                        
                        //- Dynamic credential fields container (populated by JavaScript)
                        #credentialFieldsContainer
                        
                        //- Push-style connector notice
                        #pushConnectorNotice.col-12.d-none
                            .alert.alert-info.mb-0
                                i.bi.bi-device-hdd.me-2
                                strong Push-style Connector:
                                |  After creating this account, register a device to enable data sync. The device token will be used to authenticate imports.
                        
                        //- Manual account notice (only visible when "Other" selected)
                        #manualAccountNotice.col-12.d-none
                            .alert.alert-warning.mb-0
                                i.bi.bi-hand-index.me-2
                                strong Manual Account:
                                |  No automatic sync available. You can manually link games to this account from the copy detail page.
                .modal-footer.border-secondary
                    button.btn.btn-secondary(type="button" data-bs-dismiss="modal") Cancel
                    button.btn.btn-primary(type="submit" form="addAccountForm")
                        i.bi.bi-link-45deg.me-1
                        | Link Account


block scripts
    script(type="module" src="/js/games/accounts.gen.js")
    style.
        .sync-spin {
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
