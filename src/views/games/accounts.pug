extends ../layout

block meta
    title External Accounts | Inventory Management

block content
    - const accounts = (data && data.accounts) ? data.accounts : []
    - const connectors = (data && data.connectors) ? data.connectors : []
    //- Generate provider list from registered connectors
    - const connectorProviders = connectors.map(c => c.provider)

    #liveAlerts

    .d-flex.justify-content-between.align-items-center.mb-3.flex-wrap.gap-2
        h1.h3.mb-0.text-white
            i.bi.bi-cloud.me-2
            | External Accounts
            if accounts.length > 0
                span.badge.text-bg-secondary.ms-2.fs-6 #{accounts.length}
        
        button.btn.btn-primary(type="button" data-bs-toggle="modal" data-bs-target="#addAccountModal")
            i.bi.bi-plus-lg.me-1
            | Link Account

    //- Info card
    .card.text-bg-dark.border-secondary.mb-3
        .card-body
            i.bi.bi-info-circle.me-2
            | Link your gaming accounts to sync your library.
            ul.mb-0.mt-2
                li 
                    strong Automatic import
                    |  - Games are automatically imported with metadata (player counts, multiplayer support, etc.)
                li 
                    strong Automatic copies
                    |  - Digital licenses are created automatically for each synced game
                li 
                    strong Scheduled sync
                    |  - Set up periodic syncs to keep your library up to date
                li 
                    strong No manual mapping
                    |  - Everything is handled automatically

    //- Accounts list
    if accounts.length === 0
        .card.text-bg-dark.border-secondary
            .card-body.text-center.py-5
                i.bi.bi-cloud.display-1.text-white-50.mb-3.d-block
                p.text-white-50.mb-3 No external accounts linked yet.
                button.btn.btn-outline-light(type="button" data-bs-toggle="modal" data-bs-target="#addAccountModal")
                    i.bi.bi-plus-lg.me-1
                    | Link Your First Account
    else
        //- Check which providers have connectors (case-insensitive match)
        - const connectorProviderNames = connectors.map(c => c.provider.toLowerCase())
        .row.g-3
            each account in accounts
                - const hasConnector = connectorProviderNames.includes(account.provider.toLowerCase())
                .col-md-6.col-lg-4
                    .card.text-bg-dark.border-secondary.h-100
                        .card-body
                            .d-flex.justify-content-between.align-items-start.mb-3
                                div
                                    h5.mb-1.text-white
                                        i.bi.bi-cloud.me-2
                                        | #{account.accountName}
                                    span.badge.text-bg-info #{account.provider}
                                    if !hasConnector
                                        span.badge.text-bg-warning.ms-1 Manual
                                .dropdown
                                    button.btn.btn-sm.btn-outline-secondary.dropdown-toggle(type="button" data-bs-toggle="dropdown")
                                        i.bi.bi-three-dots-vertical
                                    ul.dropdown-menu.dropdown-menu-dark.dropdown-menu-end
                                        if hasConnector
                                            li
                                                form(method="post" action=`/games/accounts/${account.id}/sync`)
                                                    button.dropdown-item(type="submit")
                                                        i.bi.bi-arrow-repeat.me-2
                                                        | Sync Now
                                            li
                                                button.dropdown-item(type="button" data-bs-toggle="modal" data-bs-target=`#scheduleModal-${account.id}`)
                                                    i.bi.bi-clock.me-2
                                                    | Schedule Sync
                                            li
                                                form(method="post" action=`/games/accounts/${account.id}/unschedule`)
                                                    button.dropdown-item(type="submit")
                                                        i.bi.bi-clock-history.me-2
                                                        | Cancel Schedule
                                            li
                                                hr.dropdown-divider
                                        li
                                            form(method="post" action=`/games/accounts/${account.id}/delete`)
                                                button.dropdown-item.text-danger(type="submit" onclick="return confirm('Remove this account?')")
                                                    i.bi.bi-trash.me-2
                                                    | Remove
                            
                            .small.text-white-50
                                if !hasConnector
                                    i.bi.bi-info-circle.me-1
                                    | Manual account (no connector) - use to track games without auto-sync
                                else if account.lastSyncedAt
                                    i.bi.bi-clock.me-1
                                    | Last synced: #{new Date(account.lastSyncedAt).toLocaleString()}
                                else
                                    i.bi.bi-exclamation-circle.me-1
                                    | Never synced
                            
                            //- Sync status container (updated via JavaScript)
                            if hasConnector
                                .sync-status-container.mt-2(data-account-id=account.id)
                                    .sync-status.text-white-50.small
                                        //- Status will be populated by JavaScript

                        .card-footer.bg-transparent.border-secondary
                            if hasConnector
                                .d-flex.gap-2
                                    form.flex-grow-1(method="post" action=`/games/accounts/${account.id}/sync`)
                                        button.btn.btn-sm.btn-outline-primary.w-100.sync-btn(type="submit" data-account-id=account.id)
                                            i.bi.bi-arrow-repeat.me-1.sync-icon
                                            | Sync Library
                                    button.btn.btn-sm.btn-outline-secondary.check-status-btn(type="button" data-account-id=account.id)
                                        i.bi.bi-arrow-clockwise.me-1
                                        | Check Status
                            else
                                .text-center.text-white-50.small
                                    i.bi.bi-hand-index.me-1
                                    | Link games manually from the copy detail page
                    
                    //- Schedule Modal for this account
                    .modal.fade(id=`scheduleModal-${account.id}` tabindex="-1")
                        .modal-dialog
                            .modal-content.text-bg-dark
                                .modal-header.border-secondary
                                    h5.modal-title
                                        i.bi.bi-clock.me-2
                                        | Schedule Periodic Sync
                                    button.btn-close.btn-close-white(type="button" data-bs-dismiss="modal")
                                .modal-body
                                    form(id=`scheduleForm-${account.id}` method="post" action=`/games/accounts/${account.id}/schedule`)
                                        label.form-label Sync Interval
                                        select.form-select.text-bg-dark(name="intervalMinutes" required)
                                            option(value="60") Every hour
                                            option(value="360") Every 6 hours
                                            option(value="720") Every 12 hours
                                            option(value="1440" selected) Daily
                                            option(value="10080") Weekly
                                        .form-text.text-white-50 Automatically sync your library at regular intervals.
                                .modal-footer.border-secondary
                                    button.btn.btn-secondary(type="button" data-bs-dismiss="modal") Cancel
                                    button.btn.btn-primary(type="submit" form=`scheduleForm-${account.id}`)
                                        i.bi.bi-check-lg.me-1
                                        | Enable Schedule

    //- Available connectors
    .card.text-bg-dark.border-secondary.mt-4
        .card-header
            h5.mb-0
                i.bi.bi-plug.me-2
                | Available Connectors
        .card-body
            if connectors.length === 0
                p.text-white-50.mb-0 No connectors available.
            else
                .row.g-2
                    each conn in connectors
                        .col-md-6.col-lg-4
                            .card.text-bg-dark.border-secondary
                                .card-body.py-2
                                    .d-flex.justify-content-between.align-items-start
                                        div
                                            h6.mb-1 #{conn.name}
                                            if conn.isAggregator
                                                span.badge.text-bg-info.small.me-1 Aggregator
                                        if conn.id === 'playnite'
                                            button.btn.btn-sm.btn-outline-primary(type="button" data-bs-toggle="modal" data-bs-target="#playniteDevicesModal")
                                                i.bi.bi-gear.me-1
                                                | Manage
                                    p.small.text-white-50.mb-1 #{conn.description}
                                    .d-flex.flex-wrap.gap-1
                                        each cap in conn.capabilities
                                            span.badge.text-bg-secondary.small #{cap.replace('_', ' ')}

    //- Playnite Devices Modal
    - const playniteDevices = (data && data.playniteDevices) ? data.playniteDevices : []
    #playniteDevicesModal.modal.fade(tabindex="-1")
        .modal-dialog.modal-lg
            .modal-content.text-bg-dark
                .modal-header.border-secondary
                    h5.modal-title
                        i.bi.bi-controller.me-2
                        | Playnite Devices
                    button.btn-close.btn-close-white(type="button" data-bs-dismiss="modal")
                .modal-body
                    .alert.alert-info.mb-3
                        i.bi.bi-info-circle.me-2
                        | Playnite is an aggregator that imports games from multiple sources (Steam, Epic, GOG, etc.) while preserving the original provider information.
                    
                    //- Device registration form
                    form#registerDeviceForm.mb-4(method="post" action="/api/integrations/playnite/devices")
                        .row.g-2.align-items-end
                            .col-md-8
                                label.form-label Device Name
                                input#deviceNameInput.form-control.text-bg-dark(type="text" name="deviceName" placeholder="e.g., Gaming PC" required)
                            .col-md-4
                                button.btn.btn-primary.w-100(type="submit")
                                    i.bi.bi-plus-lg.me-1
                                    | Register Device
                    
                    //- Device list
                    if playniteDevices.length === 0
                        .text-center.py-4
                            i.bi.bi-controller.display-4.text-white-50.d-block.mb-3
                            p.text-white-50 No Playnite devices registered yet.
                            p.small.text-white-50 Register a device to get a token for the Playnite extension.
                    else
                        .table-responsive
                            table.table.table-dark.table-hover.mb-0
                                thead
                                    tr
                                        th Device Name
                                        th Status
                                        th Last Seen
                                        th Last Import
                                        th Actions
                                tbody
                                    each device in playniteDevices
                                        tr
                                            td #{device.name}
                                            td
                                                if device.status === 'active'
                                                    span.badge.text-bg-success Active
                                                else
                                                    span.badge.text-bg-danger Revoked
                                            td
                                                if device.lastSeenAt
                                                    | #{new Date(device.lastSeenAt).toLocaleDateString()}
                                                else
                                                    span.text-white-50 Never
                                            td
                                                if device.lastImportAt
                                                    | #{new Date(device.lastImportAt).toLocaleDateString()}
                                                else
                                                    span.text-white-50 Never
                                            td
                                                if device.status === 'active'
                                                    form.d-inline(method="post" action=`/api/integrations/playnite/devices/${device.id}/revoke`)
                                                        button.btn.btn-sm.btn-outline-warning(type="submit" onclick="return confirm('Revoke this device? You will need to register a new device.')")
                                                            i.bi.bi-x-circle.me-1
                                                            | Revoke
                                
                    .mt-4
                        h6.text-white-50
                            i.bi.bi-question-circle.me-1
                            | How to use
                        ol.small.text-white-50
                            li Register a device above and copy the token
                            li Install the Playnite extension (available separately)
                            li Configure the extension with your token
                            li Sync your library from Playnite
                .modal-footer.border-secondary
                    button.btn.btn-secondary(type="button" data-bs-dismiss="modal") Close

    //- Add Account Modal
    #addAccountModal.modal.fade(tabindex="-1")
        .modal-dialog
            .modal-content.text-bg-dark
                .modal-header.border-secondary
                    h5.modal-title
                        i.bi.bi-plus-circle.me-2
                        | Link External Account
                    button.btn-close.btn-close-white(type="button" data-bs-dismiss="modal")
                .modal-body
                    //- Provider list generated from registered connectors
                    form#addAccountForm.row.g-3(method="post" action="/games/accounts")
                        .col-12
                            label.form-label Provider *
                            select#providerSelect.form-select.text-bg-dark(name="provider" required)
                                //- Options from registered connectors
                                each p in connectorProviders
                                    option(value=p selected=(p === connectorProviders[0])) #{p}
                                option(value="Other") Other (Manual only)
                        
                        //- Custom provider name (only visible when "Other" selected)
                        #customProviderField.col-12.d-none
                            label.form-label Custom Provider Name *
                            input#customProviderInput.form-control.text-bg-dark(type="text" placeholder="e.g., My Custom Store")
                            .form-text.text-white-50 No connector available. Games must be added manually.
                        
                        .col-12
                            label.form-label Account Name *
                            input.form-control.text-bg-dark(type="text" name="accountName" required placeholder="e.g., My Steam Account")
                        
                        //- Credential fields (hidden for "Other")
                        #credentialFields
                            .col-12
                                label.form-label User ID / Steam ID
                                input.form-control.text-bg-dark(type="text" name="externalUserId" placeholder="Your external user ID")
                            .col-12.mt-2
                                label.form-label API Key / Token (optional)
                                input.form-control.text-bg-dark(type="password" name="tokenRef" placeholder="API key or token if required")
                                .form-text.text-white-50 This will be stored securely and used for syncing.
                        
                        //- Manual account notice (only visible when "Other" selected)
                        #manualAccountNotice.col-12.d-none
                            .alert.alert-warning.mb-0
                                i.bi.bi-hand-index.me-2
                                strong Manual Account:
                                |  No automatic sync available. You can manually link games to this account from the copy detail page.
                .modal-footer.border-secondary
                    button.btn.btn-secondary(type="button" data-bs-dismiss="modal") Cancel
                    button.btn.btn-primary(type="submit" form="addAccountForm")
                        i.bi.bi-link-45deg.me-1
                        | Link Account

block scripts
    script.
        document.addEventListener('DOMContentLoaded', function() {
            const providerSelect = document.getElementById('providerSelect');
            const customProviderField = document.getElementById('customProviderField');
            const customProviderInput = document.getElementById('customProviderInput');
            const credentialFields = document.getElementById('credentialFields');
            const manualAccountNotice = document.getElementById('manualAccountNotice');
            const addAccountForm = document.getElementById('addAccountForm');
            
            if (providerSelect) {
                providerSelect.addEventListener('change', function() {
                    const isOther = this.value === 'Other';
                    
                    if (isOther) {
                        customProviderField.classList.remove('d-none');
                        credentialFields.classList.add('d-none');
                        manualAccountNotice.classList.remove('d-none');
                        customProviderInput.required = true;
                    } else {
                        customProviderField.classList.add('d-none');
                        credentialFields.classList.remove('d-none');
                        manualAccountNotice.classList.add('d-none');
                        customProviderInput.required = false;
                    }
                });
                
                // On form submit, if "Other" is selected, use custom provider name
                addAccountForm.addEventListener('submit', function(e) {
                    if (providerSelect.value === 'Other') {
                        // Replace the select value with custom provider input
                        providerSelect.name = '';
                        const hiddenInput = document.createElement('input');
                        hiddenInput.type = 'hidden';
                        hiddenInput.name = 'provider';
                        hiddenInput.value = customProviderInput.value.trim() || 'Other';
                        addAccountForm.appendChild(hiddenInput);
                    }
                });
            }
            
            // Check sync status on page load for all accounts
            const statusContainers = document.querySelectorAll('.sync-status-container');
            statusContainers.forEach(container => {
                const accountId = container.dataset.accountId;
                if (accountId) {
                    checkSyncStatus(accountId);
                }
            });
            
            // Add event listeners for check status buttons
            document.querySelectorAll('.check-status-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const accountId = this.dataset.accountId;
                    if (accountId && isValidUUID(accountId)) {
                        checkSyncStatus(accountId);
                    }
                });
            });
        });
        
        // Validate that a string is a valid UUID format
        function isValidUUID(str) {
            const uuidRegex = /^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i;
            return uuidRegex.test(str);
        }
        
        // Track accounts being polled
        const pollingIntervals = {};
        
        // Check sync status for an account
        async function checkSyncStatus(accountId) {
            // Validate accountId format to prevent path traversal
            if (!accountId || !isValidUUID(accountId)) {
                console.error('Invalid account ID format');
                return;
            }
            
            try {
                const response = await fetch(`/games/accounts/${encodeURIComponent(accountId)}/status`);
                if (!response.ok) return;
                
                const status = await response.json();
                updateSyncStatusUI(accountId, status);
                
                // If sync is in progress, start polling
                if (status.latestJob && status.latestJob.status === 'in_progress') {
                    startPolling(accountId);
                } else {
                    stopPolling(accountId);
                }
            } catch (err) {
                console.error('Failed to check sync status:', err);
            }
        }
        
        // Update the UI with sync status
        function updateSyncStatusUI(accountId, status) {
            const container = document.querySelector(`.sync-status-container[data-account-id="${accountId}"]`);
            if (!container) return;
            
            const statusDiv = container.querySelector('.sync-status');
            const syncBtn = document.querySelector(`.sync-btn[data-account-id="${accountId}"]`);
            const syncIcon = syncBtn?.querySelector('.sync-icon');
            
            if (!status.latestJob) {
                statusDiv.innerHTML = '';
                return;
            }
            
            const job = status.latestJob;
            let html = '';
            let spinIcon = false;
            
            switch (job.status) {
                case 'pending':
                    html = '<i class="bi bi-hourglass-start me-1"></i>Sync pending...';
                    spinIcon = true;
                    break;
                case 'in_progress':
                    html = '<i class="bi bi-arrow-repeat me-1 sync-spin"></i>Sync in progress...';
                    if (job.entriesProcessed !== null) {
                        html += ` (${job.entriesProcessed} games processed)`;
                    }
                    spinIcon = true;
                    break;
                case 'completed':
                    html = `<i class="bi bi-check-circle me-1 text-success"></i>`;
                    html += `Completed: ${job.entriesProcessed || 0} games`;
                    break;
                case 'failed':
                    html = `<i class="bi bi-x-circle me-1 text-danger"></i>`;
                    html += `Failed: ${job.errorMessage || 'Unknown error'}`;
                    break;
            }
            
            statusDiv.innerHTML = html;
            
            // Add/remove spinning animation on sync button
            if (syncIcon) {
                if (spinIcon) {
                    syncIcon.classList.add('sync-spin');
                    if (syncBtn) syncBtn.disabled = true;
                } else {
                    syncIcon.classList.remove('sync-spin');
                    if (syncBtn) syncBtn.disabled = false;
                }
            }
        }
        
        // Start polling for sync status
        function startPolling(accountId) {
            if (pollingIntervals[accountId]) return; // Already polling
            
            pollingIntervals[accountId] = setInterval(() => {
                checkSyncStatus(accountId);
            }, 3000); // Poll every 3 seconds
        }
        
        // Stop polling for sync status
        function stopPolling(accountId) {
            if (pollingIntervals[accountId]) {
                clearInterval(pollingIntervals[accountId]);
                delete pollingIntervals[accountId];
            }
        }
        
        // Handle Playnite device registration
        const registerDeviceForm = document.getElementById('registerDeviceForm');
        if (registerDeviceForm) {
            registerDeviceForm.addEventListener('submit', async function(e) {
                e.preventDefault();
                const deviceNameInput = document.getElementById('deviceNameInput');
                const deviceName = deviceNameInput.value.trim();
                
                if (!deviceName) return;
                
                try {
                    const response = await fetch('/api/integrations/playnite/devices', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({deviceName})
                    });
                    
                    const data = await response.json();
                    
                    if (response.ok && data.token) {
                        // Show the token to the user
                        const tokenModal = document.createElement('div');
                        tokenModal.innerHTML = `
                            <div class="modal fade" id="tokenResultModal" tabindex="-1">
                                <div class="modal-dialog">
                                    <div class="modal-content text-bg-dark">
                                        <div class="modal-header border-secondary">
                                            <h5 class="modal-title"><i class="bi bi-key me-2"></i>Device Token</h5>
                                            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                                        </div>
                                        <div class="modal-body">
                                            <div class="alert alert-warning">
                                                <i class="bi bi-exclamation-triangle me-2"></i>
                                                <strong>Save this token now!</strong> It will not be shown again.
                                            </div>
                                            <label class="form-label">Device ID</label>
                                            <input type="text" class="form-control text-bg-dark mb-3" value="${data.deviceId}" readonly>
                                            <label class="form-label">Token</label>
                                            <div class="input-group">
                                                <input type="text" class="form-control text-bg-dark" id="deviceToken" value="${data.token}" readonly>
                                                <button class="btn btn-outline-secondary" type="button" onclick="navigator.clipboard.writeText(document.getElementById('deviceToken').value).then(() => this.innerHTML = '<i class=\\'bi bi-check\\'></i>')">
                                                    <i class="bi bi-clipboard"></i>
                                                </button>
                                            </div>
                                            <p class="small text-white-50 mt-2">Use this token in the Playnite extension to sync your library.</p>
                                        </div>
                                        <div class="modal-footer border-secondary">
                                            <button type="button" class="btn btn-primary" data-bs-dismiss="modal" onclick="location.reload()">Done</button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        `;
                        document.body.appendChild(tokenModal);
                        const modal = new bootstrap.Modal(document.getElementById('tokenResultModal'));
                        modal.show();
                        
                        // Clear input
                        deviceNameInput.value = '';
                    } else {
                        alert(data.message || 'Failed to register device');
                    }
                } catch (err) {
                    console.error('Failed to register device:', err);
                    alert('Failed to register device');
                }
            });
        }
    
    style.
        .sync-spin {
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
