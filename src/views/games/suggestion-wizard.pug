extends ../layout

block meta
    title Random Game Suggestion | Inventory Management

block content
    - const platforms = (data && data.platforms) ? data.platforms : []
    - const gameTypes = (data && data.gameTypes) ? data.gameTypes : []
    - const criteria = (data && data.criteria) ? data.criteria : {}
    - const selectedModesArray = criteria.selectedModes ? (Array.isArray(criteria.selectedModes) ? criteria.selectedModes : [criteria.selectedModes]) : []

    #liveAlerts

    //- Breadcrumb navigation
    nav.mb-2(aria-label="breadcrumb")
        ol.breadcrumb.mb-0
            li.breadcrumb-item
                a.text-info(href="/") Home
            li.breadcrumb-item
                a.text-info(href="/games") Games
            li.breadcrumb-item.active.text-white(aria-current="page") Random Suggestion

    .d-flex.justify-content-between.align-items-center.mb-3
        h1.h3.mb-0.text-white
            i.bi.bi-shuffle.me-2
            | Random Game Suggestion

    .row.justify-content-center
        .col-lg-8
            .card.text-bg-dark.border-secondary
                .card-body.p-4
                    //- Intro text
                    .text-center.mb-4
                        i.bi.bi-shuffle.display-4.text-info.mb-3.d-block
                        p.text-white-50.mb-0 Can't decide what to play? Let us suggest a game based on your preferences!

                    form#suggestionForm(method="post" action="/games/suggest")
                        //- Player Count (Big Button Section)
                        .mb-4
                            h5.text-white.mb-3
                                i.bi.bi-people.me-2
                                | How many players?
                            .d-grid.gap-2.d-md-flex.justify-content-center.flex-wrap
                                button.btn.btn-lg.btn-outline-light.player-btn(type="button" data-value="1" style="min-width: 100px;")
                                    i.bi.bi-person.me-2
                                    | 1
                                button.btn.btn-lg.btn-outline-light.player-btn(type="button" data-value="2" style="min-width: 100px;")
                                    i.bi.bi-people.me-2
                                    | 2
                                button.btn.btn-lg.btn-outline-light.player-btn(type="button" data-value="3" style="min-width: 100px;")
                                    i.bi.bi-people.me-2
                                    | 3
                                button.btn.btn-lg.btn-outline-light.player-btn(type="button" data-value="4" style="min-width: 100px;")
                                    i.bi.bi-people.me-2
                                    | 4
                                button.btn.btn-lg.btn-outline-light.player-btn(type="button" data-value="5+" style="min-width: 100px;")
                                    i.bi.bi-people.me-2
                                    | 5+
                            input#playerCount(type="hidden" name="playerCount" value=criteria.playerCount || "")
                            .mt-2.text-center
                                small.text-white-50 Or enter a specific number:
                            .input-group.mt-2.justify-content-center
                                input#customPlayerCount.form-control.text-bg-dark.border-secondary(type="number" min="1" placeholder="e.g., 8" style="max-width: 150px;")
                                button.btn.btn-outline-info(type="button" onclick="setCustomPlayerCount()")
                                    | Set

                        hr.border-secondary

                        //- Game Modes (Checkbox multi-select with OR logic)
                        .mb-4
                            h5.text-white.mb-3
                                i.bi.bi-controller.me-2
                                | How do you want to play?
                            p.text-white-50.small.mb-3 Select one or more modes. Games matching any selected mode will be included.
                            .row.g-3
                                .col-md-6.col-lg-3
                                    .d-grid
                                        input.btn-check#modeOnline(type="checkbox" name="selectedModes" value="online" autocomplete="off" checked=selectedModesArray.includes('online'))
                                        label.btn.btn-lg.btn-outline-primary.text-start.py-3(for="modeOnline")
                                            i.bi.bi-globe.me-2.fs-4
                                            span.d-block Online
                                            small.d-block.mt-1 Internet multiplayer
                                .col-md-6.col-lg-3
                                    .d-grid
                                        input.btn-check#modeCouch(type="checkbox" name="selectedModes" value="couch" autocomplete="off" checked=selectedModesArray.includes('couch'))
                                        label.btn.btn-lg.btn-outline-success.text-start.py-3(for="modeCouch")
                                            i.bi.bi-display.me-2.fs-4
                                            span.d-block Couch Co-op
                                            small.d-block.mt-1 Same screen / device
                                .col-md-6.col-lg-3
                                    .d-grid
                                        input.btn-check#modeLAN(type="checkbox" name="selectedModes" value="lan" autocomplete="off" checked=selectedModesArray.includes('lan'))
                                        label.btn.btn-lg.btn-outline-info.text-start.py-3(for="modeLAN")
                                            i.bi.bi-hdd-network.me-2.fs-4
                                            span.d-block LAN / Multi-Device
                                            small.d-block.mt-1 Separate systems
                                .col-md-6.col-lg-3
                                    .d-grid
                                        input.btn-check#modePhysical(type="checkbox" name="selectedModes" value="physical" autocomplete="off" checked=selectedModesArray.includes('physical'))
                                        label.btn.btn-lg.btn-outline-warning.text-start.py-3(for="modePhysical")
                                            i.bi.bi-dice-5.me-2.fs-4
                                            span.d-block Physical
                                            small.d-block.mt-1 Board / card games

                        hr.border-secondary

                        //- Advanced Options (Collapsible)
                        .accordion#advancedOptionsAccordion
                            .accordion-item.bg-dark.border-secondary
                                h2.accordion-header
                                    button.accordion-button.bg-dark.text-white.collapsed(type="button" data-bs-toggle="collapse" data-bs-target="#advancedOptionsCollapse")
                                        i.bi.bi-sliders.me-2
                                        | Advanced Options
                                #advancedOptionsCollapse.accordion-collapse.collapse
                                    .accordion-body
                                        //- Mode Weight Distribution
                                        .mb-4#modeWeightsSection(style="display:none;")
                                            label.form-label.text-white
                                                i.bi.bi-pie-chart.me-1
                                                | Mode Distribution
                                            p.text-white-50.small.mb-2 Adjust how often each selected mode is picked. Leave equal for uniform distribution.
                                            .row.g-3
                                                .col-md-6.col-lg-3.mode-weight-group(data-mode="online" style="display:none;")
                                                    label.form-label.small.text-primary
                                                        i.bi.bi-globe.me-1
                                                        | Online
                                                        span.ms-1.badge.text-bg-primary.weight-display 25%
                                                    input.form-range.mode-weight-slider(type="range" name="modeWeight_online" min="0" max="100" value=(criteria.modeWeight_online || "25") data-mode="online")
                                                .col-md-6.col-lg-3.mode-weight-group(data-mode="couch" style="display:none;")
                                                    label.form-label.small.text-success
                                                        i.bi.bi-display.me-1
                                                        | Couch Co-op
                                                        span.ms-1.badge.text-bg-success.weight-display 25%
                                                    input.form-range.mode-weight-slider(type="range" name="modeWeight_couch" min="0" max="100" value=(criteria.modeWeight_couch || "25") data-mode="couch")
                                                .col-md-6.col-lg-3.mode-weight-group(data-mode="lan" style="display:none;")
                                                    label.form-label.small.text-info
                                                        i.bi.bi-hdd-network.me-1
                                                        | LAN
                                                        span.ms-1.badge.text-bg-info.weight-display 25%
                                                    input.form-range.mode-weight-slider(type="range" name="modeWeight_lan" min="0" max="100" value=(criteria.modeWeight_lan || "25") data-mode="lan")
                                                .col-md-6.col-lg-3.mode-weight-group(data-mode="physical" style="display:none;")
                                                    label.form-label.small.text-warning
                                                        i.bi.bi-dice-5.me-1
                                                        | Physical
                                                        span.ms-1.badge.text-bg-warning.text-dark.weight-display 25%
                                                    input.form-range.mode-weight-slider(type="range" name="modeWeight_physical" min="0" max="100" value=(criteria.modeWeight_physical || "25") data-mode="physical")

                                        //- Platform Filters
                                        .mb-3
                                            label.form-label.text-white
                                                i.bi.bi-cpu.me-1
                                                | Platforms
                                            .row.g-2
                                                .col-md-6
                                                    label.form-label.small.text-white-50 Include (whitelist)
                                                    select#includePlatforms.form-select.text-bg-dark.border-secondary(name="includePlatforms" multiple size="5")
                                                        - const selectedIncludePlatforms = criteria.includePlatforms ? (Array.isArray(criteria.includePlatforms) ? criteria.includePlatforms : [criteria.includePlatforms]) : []
                                                        each p in platforms
                                                            option(value=p.name selected=selectedIncludePlatforms.includes(p.name)) #{p.name}
                                                .col-md-6
                                                    label.form-label.small.text-white-50 Exclude (blacklist)
                                                    select#excludePlatforms.form-select.text-bg-dark.border-secondary(name="excludePlatforms" multiple size="5")
                                                        - const selectedExcludePlatforms = criteria.excludePlatforms ? (Array.isArray(criteria.excludePlatforms) ? criteria.excludePlatforms : [criteria.excludePlatforms]) : []
                                                        each p in platforms
                                                            option(value=p.name selected=selectedExcludePlatforms.includes(p.name)) #{p.name}
                                            small.text-white-50 Hold Ctrl/Cmd to select multiple. Leave empty to include all.

                                        //- Game Types
                                        .mb-3
                                            label.form-label.text-white
                                                i.bi.bi-grid.me-1
                                                | Game Types
                                            select#gameTypes.form-select.text-bg-dark.border-secondary(name="gameTypes" multiple size="5")
                                                - const selectedGameTypes = criteria.gameTypes ? (Array.isArray(criteria.gameTypes) ? criteria.gameTypes : [criteria.gameTypes]) : []
                                                each type in gameTypes
                                                    option(value=type.value selected=selectedGameTypes.includes(type.value)) #{type.label}
                                            small.text-white-50 Hold Ctrl/Cmd to select multiple. Leave empty to include all types.

                        //- Submit Button
                        .d-grid.gap-2.mt-4
                            button#submitBtn.btn.btn-primary.btn-lg(type="submit")
                                i.bi.bi-shuffle.me-2
                                | Suggest a Game!
                            a.btn.btn-outline-light(href="/games")
                                i.bi.bi-arrow-left.me-2
                                | Back to Games

block scripts
    script.
        // Player count button handler
        document.querySelectorAll('.player-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                // Remove active class from all buttons
                document.querySelectorAll('.player-btn').forEach(b => b.classList.remove('active'));
                // Add active class to clicked button
                this.classList.add('active');
                // Set hidden input value
                const value = this.getAttribute('data-value');
                if (value === '5+') {
                    document.getElementById('playerCount').value = '5';
                } else {
                    document.getElementById('playerCount').value = value;
                }
                // Clear custom input
                document.getElementById('customPlayerCount').value = '';
            });
        });

        // Custom player count handler
        function setCustomPlayerCount() {
            const input = document.getElementById('customPlayerCount');
            const value = input.value;
            if (value && parseInt(value) > 0) {
                // Remove active class from all buttons
                document.querySelectorAll('.player-btn').forEach(b => b.classList.remove('active'));
                // Set hidden input
                document.getElementById('playerCount').value = value;
            }
        }

        // Initialize Select2 for better multi-select experience
        $(document).ready(function() {
            $('#includePlatforms, #excludePlatforms, #gameTypes').select2({
                theme: 'bootstrap-5',
                placeholder: 'Select options...',
                allowClear: true,
                width: '100%'
            });
            
            // Apply dark theme styling to Select2 dropdowns
            const style = document.createElement('style');
            style.textContent = `
                .select2-container--bootstrap-5 .select2-selection {
                    background-color: #212529 !important;
                    border-color: #495057 !important;
                    color: #fff !important;
                }
                .select2-container--bootstrap-5 .select2-selection--multiple .select2-selection__choice {
                    background-color: #495057 !important;
                    border-color: #6c757d !important;
                    color: #fff !important;
                }
                .select2-container--bootstrap-5 .select2-selection--multiple .select2-selection__choice__remove {
                    color: #fff !important;
                }
                .select2-container--bootstrap-5 .select2-selection--multiple .select2-selection__choice__remove:hover {
                    color: #dc3545 !important;
                }
                .select2-container--bootstrap-5 .select2-dropdown {
                    background-color: #212529 !important;
                    border-color: #495057 !important;
                }
                .select2-container--bootstrap-5 .select2-results__option {
                    color: #fff !important;
                }
                .select2-container--bootstrap-5 .select2-results__option--highlighted {
                    background-color: #0d6efd !important;
                    color: #fff !important;
                }
                .select2-container--bootstrap-5 .select2-search__field {
                    background-color: #212529 !important;
                    border-color: #495057 !important;
                    color: #fff !important;
                }
            `;
            document.head.appendChild(style);
            
            // Restore player count from criteria
            const playerCount = '#{criteria.playerCount || ''}';
            if (playerCount) {
                document.getElementById('playerCount').value = playerCount;
                document.querySelectorAll('.player-btn').forEach(btn => {
                    const btnValue = btn.getAttribute('data-value');
                    if ((btnValue === '5+' && parseInt(playerCount) >= 5) || btnValue === playerCount) {
                        btn.classList.add('active');
                    }
                });
            }

            // --- Mode weight distribution ---
            function updateWeightVisibility() {
                const checked = Array.from(document.querySelectorAll('input[name="selectedModes"]:checked'))
                    .map(el => el.value);
                const section = document.getElementById('modeWeightsSection');
                // Show weight section only when 2+ modes selected
                section.style.display = checked.length >= 2 ? '' : 'none';
                // Show/hide individual sliders
                document.querySelectorAll('.mode-weight-group').forEach(grp => {
                    grp.style.display = checked.includes(grp.dataset.mode) ? '' : 'none';
                });
                updateWeightDisplays();
            }

            function updateWeightDisplays() {
                const sliders = Array.from(document.querySelectorAll('.mode-weight-slider'))
                    .filter(s => s.closest('.mode-weight-group').style.display !== 'none');
                const total = sliders.reduce((s, el) => s + Number(el.value), 0) || 1;
                sliders.forEach(slider => {
                    const pct = Math.round((Number(slider.value) / total) * 100);
                    const badge = slider.closest('.mode-weight-group').querySelector('.weight-display');
                    if (badge) badge.textContent = pct + '%';
                });
            }

            // Bind mode checkboxes to weight visibility
            document.querySelectorAll('input[name="selectedModes"]').forEach(cb => {
                cb.addEventListener('change', updateWeightVisibility);
            });
            // Bind slider input
            document.querySelectorAll('.mode-weight-slider').forEach(slider => {
                slider.addEventListener('input', updateWeightDisplays);
            });
            // Initialize
            updateWeightVisibility();
        });
