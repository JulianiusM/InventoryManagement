extends ../layout

block meta
    title Platforms | Inventory Management

block content
    - const platforms = (data && data.platforms) ? data.platforms : []

    #liveAlerts

    //- Breadcrumb navigation
    nav.mb-2(aria-label="breadcrumb")
        ol.breadcrumb.mb-0
            li.breadcrumb-item
                a.text-info(href="/") Home
            li.breadcrumb-item
                a.text-info(href="/games") Games
            li.breadcrumb-item.active.text-white(aria-current="page") Platforms

    .d-flex.justify-content-between.align-items-center.mb-3.flex-wrap.gap-2
        h1.h3.mb-0.text-white
            i.bi.bi-cpu.me-2
            | Platforms
            if platforms.length > 0
                span.badge.text-bg-secondary.ms-2.fs-6 #{platforms.length}
        
        button.btn.btn-primary(type="button" data-bs-toggle="modal" data-bs-target="#addPlatformModal")
            i.bi.bi-plus-lg.me-1
            | Add Platform

    //- Info card
    .card.text-bg-dark.border-secondary.mb-3
        .card-body
            i.bi.bi-info-circle.me-2
            | Platforms define where games can be played. You can add custom platforms to track your game collection across any device or format.
            ul.mb-0.mt-2
                li 
                    strong Default platforms
                    |  are provided as a starting point
                li 
                    strong Custom platforms
                    |  can be added for any device or format you use
                li 
                    strong Aliases
                    |  help normalize platform names during sync (e.g., "PS5" → "PlayStation 5")

    //- Platforms list
    if platforms.length === 0
        .card.text-bg-dark.border-secondary
            .card-body.text-center.py-5
                i.bi.bi-cpu.display-1.text-white-50.mb-3.d-block
                p.text-white-50.mb-3 No platforms yet.
                button.btn.btn-outline-light(type="button" data-bs-toggle="modal" data-bs-target="#addPlatformModal")
                    i.bi.bi-plus-lg.me-1
                    | Add Your First Platform
    else
        .card.text-bg-dark.border-secondary
            .card-body
                .table-responsive
                    table.table.table-dark.table-hover.align-middle.mb-0
                        thead
                            tr
                                th Platform Name
                                th Description
                                th Aliases
                                th Type
                                th.text-end Actions
                        tbody
                            each platform in platforms
                                tr
                                    td
                                        i.bi.bi-cpu.me-2
                                        | #{platform.name}
                                    td.text-white-50 #{platform.description || '—'}
                                    td
                                        if platform.aliases
                                            - const aliasCount = platform.aliases.split(',').filter(a => a.trim()).length
                                            span.badge.text-bg-secondary(title=platform.aliases) #{aliasCount} aliases
                                        else
                                            span.text-white-50.small None
                                    td
                                        if platform.isDefault
                                            span.badge.text-bg-info Default
                                        else
                                            span.badge.text-bg-secondary Custom
                                    td.text-end
                                        button.btn.btn-sm.btn-outline-light.me-1(type="button" title="Edit" data-bs-toggle="modal" data-bs-target=`#editPlatformModal-${platform.id}`)
                                            i.bi.bi-pencil
                                        if !platform.isDefault
                                            button.btn.btn-sm.btn-outline-light.me-1(type="button" title="Merge" data-bs-toggle="modal" data-bs-target=`#mergePlatformModal-${platform.id}`)
                                                i.bi.bi-arrow-left-right
                                            form.d-inline(method="post" action=`/games/platforms/${platform.id}/delete`)
                                                button.btn.btn-sm.btn-outline-danger(type="submit" title="Delete" onclick="return confirm('Delete this platform?')")
                                                    i.bi.bi-trash
                                                    i.bi.bi-trash

    //- Add Platform Modal
    #addPlatformModal.modal.fade(tabindex="-1")
        .modal-dialog
            .modal-content.text-bg-dark
                .modal-header.border-secondary
                    h5.modal-title
                        i.bi.bi-plus-circle.me-2
                        | Add Platform
                    button.btn-close.btn-close-white(type="button" data-bs-dismiss="modal")
                .modal-body
                    form#addPlatformForm.row.g-3(method="post" action="/games/platforms")
                        .col-12
                            label.form-label Platform Name *
                            input.form-control.text-bg-dark(type="text" name="name" required placeholder="e.g., Steam Deck, Atari 2600, etc.")
                            .form-text.text-white-50 Enter a unique platform name.
                        .col-12
                            label.form-label Description
                            input.form-control.text-bg-dark(type="text" name="description" placeholder="Optional description")
                        .col-12
                            label.form-label Aliases
                            input.form-control.text-bg-dark(type="text" name="aliases" placeholder="e.g., steamdeck, sd")
                            .form-text.text-white-50 Comma-separated alternative names for this platform (used during game sync).
                .modal-footer.border-secondary
                    button.btn.btn-secondary(type="button" data-bs-dismiss="modal") Cancel
                    button.btn.btn-primary(type="submit" form="addPlatformForm")
                        i.bi.bi-plus-lg.me-1
                        | Add Platform

    //- Edit Platform Modals (one for each platform)
    each platform in platforms
        .modal.fade(id=`editPlatformModal-${platform.id}` tabindex="-1")
            .modal-dialog
                .modal-content.text-bg-dark
                    .modal-header.border-secondary
                        h5.modal-title
                            i.bi.bi-pencil.me-2
                            | Edit Platform
                        button.btn-close.btn-close-white(type="button" data-bs-dismiss="modal")
                    .modal-body
                        form.row.g-3(id=`editPlatformForm-${platform.id}` method="post" action=`/games/platforms/${platform.id}/update`)
                            if !platform.isDefault
                                .col-12
                                    label.form-label Platform Name *
                                    input.form-control.text-bg-dark(type="text" name="name" value=platform.name required)
                                .col-12
                                    label.form-label Description
                                    input.form-control.text-bg-dark(type="text" name="description" value=platform.description || '')
                            else
                                .col-12
                                    label.form-label Platform Name
                                    input.form-control.text-bg-dark(type="text" value=platform.name disabled)
                                    .form-text.text-white-50 Default platforms cannot be renamed.
                                .col-12
                                    label.form-label Description
                                    input.form-control.text-bg-dark(type="text" value=platform.description || '' disabled)
                            .col-12
                                label.form-label Aliases
                                input.form-control.text-bg-dark(type="text" name="aliases" value=platform.aliases || '' placeholder="e.g., ps5, playstation5, sony playstation 5")
                                .form-text.text-white-50 Comma-separated alternative names. During sync, these names will normalize to "#{platform.name}".
                    .modal-footer.border-secondary
                        button.btn.btn-secondary(type="button" data-bs-dismiss="modal") Cancel
                        button.btn.btn-primary(type="submit" form=`editPlatformForm-${platform.id}`)
                            i.bi.bi-check-lg.me-1
                            | Save Changes

    //- Merge Platform Modals (one for each custom platform)
    each platform in platforms
        if !platform.isDefault
            .modal.fade(id=`mergePlatformModal-${platform.id}` tabindex="-1")
                .modal-dialog
                    .modal-content.text-bg-dark
                        .modal-header.border-secondary
                            h5.modal-title
                                i.bi.bi-arrow-left-right.me-2
                                | Merge Platform
                            button.btn-close.btn-close-white(type="button" data-bs-dismiss="modal")
                        .modal-body
                            .alert.alert-warning.mb-3
                                i.bi.bi-exclamation-triangle.me-2
                                | This will update all game releases using "#{platform.name}" to use the selected target platform, then delete "#{platform.name}".
                            form.row.g-3(id=`mergePlatformForm-${platform.id}` method="post" action="/games/platforms/merge")
                                input(type="hidden" name="sourceId" value=platform.id)
                                .col-12
                                    label.form-label Target Platform *
                                    select.form-select.text-bg-dark(name="targetId" required)
                                        option(value="") Select target platform...
                                        each p in platforms
                                            if p.id !== platform.id
                                                option(value=p.id) #{p.name}#{p.isDefault ? ' (Default)' : ''}
                        .modal-footer.border-secondary
                            button.btn.btn-secondary(type="button" data-bs-dismiss="modal") Cancel
                            button.btn.btn-warning(type="submit" form=`mergePlatformForm-${platform.id}` onclick="return confirm('This will permanently merge the platforms. Continue?')")
                                i.bi.bi-arrow-left-right.me-1
                                | Merge

block scripts
    script(type="module" src="/js/games/platforms.gen.js")
