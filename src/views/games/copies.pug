extends ../layout

block meta
    title Game Copies | Inventory Management

block content
    - const copies = (data && data.copies) ? data.copies : []
    - const locations = (data && data.locations) ? data.locations : []
    - const accounts = (data && data.accounts) ? data.accounts : []
    - const pagination = (data && data.pagination) ? data.pagination : {page: 1, totalPages: 1, hasNext: false, hasPrev: false, totalCount: 0}
    - const copyType = data.copyType || ''
    - const locationFilter = data.locationFilter || ''
    - const providerFilter = data.providerFilter || ''

    #liveAlerts

    .d-flex.justify-content-between.align-items-center.mb-3.flex-wrap.gap-2
        h1.h3.mb-0.text-white
            i.bi.bi-collection.me-2
            | Game Copies
            if pagination.totalCount > 0
                span.badge.text-bg-secondary.ms-2.fs-6 #{pagination.totalCount}

    //- Filters
    .card.text-bg-dark.border-secondary.mb-3
        .card-body.py-2
            form(method="get" action="/games/copies")
                .row.g-2.align-items-center
                    .col-md-4
                        select#copyTypeFilter.form-select.text-bg-dark.border-secondary(name="copyType")
                            option(value="" selected=(copyType === '')) All types
                            option(value="digital_license" selected=(copyType === 'digital_license')) Digital
                            option(value="physical_copy" selected=(copyType === 'physical_copy')) Physical
                    .col-md-4
                        select#locationFilter.form-select.text-bg-dark.border-secondary(name="location")
                            option(value="" selected=(locationFilter === '')) All locations
                            option(value="unassigned" selected=(locationFilter === 'unassigned')) Unassigned
                            each loc in locations
                                option(value=loc.id selected=(locationFilter === loc.id)) #{loc.name}
                    .col-md-4
                        button.btn.btn-primary.w-100(type="submit")
                            i.bi.bi-funnel.me-1
                            | Filter

    //- Copies list
    if copies.length === 0
        .card.text-bg-dark.border-secondary
            .card-body.text-center.py-5
                i.bi.bi-collection.display-1.text-white-50.mb-3.d-block
                p.text-white-50.mb-3 No game copies yet.
                a.btn.btn-outline-light(href="/games") Browse games to add copies
    else
        .table-responsive
            table.table.table-dark.table-hover.align-middle
                thead
                    tr
                        th Game
                        th Platform
                        th Type
                        th Location/Account
                        th Condition
                        th.text-end Actions
                tbody
                    each copy in copies
                        tr
                            td
                                if copy.gameRelease && copy.gameRelease.gameTitle
                                    a.text-white.text-decoration-none(href=`/games/titles/${copy.gameRelease.gameTitle.id}`)
                                        | #{copy.gameRelease.gameTitle.name}
                                else
                                    span.text-white-50 Unknown
                            td
                                if copy.gameRelease
                                    span.badge.text-bg-info #{copy.gameRelease.platform}
                            td
                                if copy.gameCopyType === 'digital_license'
                                    span.badge.text-bg-primary
                                        i.bi.bi-cloud.me-1
                                        | Digital
                                else
                                    span.badge.text-bg-success
                                        i.bi.bi-disc.me-1
                                        | Physical
                            td
                                if copy.gameCopyType === 'digital_license'
                                    if copy.externalAccount
                                        i.bi.bi-cloud.me-1.text-white-50
                                        | #{copy.externalAccount.accountName}
                                        span.text-white-50.small.ms-1 (#{copy.externalAccount.provider})
                                    else
                                        span.text-white-50 â€”
                                else
                                    if copy.location
                                        i.bi.bi-geo-alt.me-1.text-white-50
                                        | #{copy.location.name}
                                    else
                                        span.text-white-50 Unassigned
                            td.text-white-50 #{copy.condition ? copy.condition.replace('_', ' ') : 'â€”'}
                            td.text-end
                                a.btn.btn-sm.btn-outline-light(href=`/games/copies/${copy.id}`)
                                    i.bi.bi-eye
        
        //- Pagination
        if pagination.totalPages > 1
            .d-flex.justify-content-center.mt-4
                nav(aria-label="Copies pagination")
                    ul.pagination
                        li.page-item(class=!pagination.hasPrev ? 'disabled' : '')
                            a.page-link.text-bg-dark.border-secondary(href=`/games/copies?page=${pagination.page - 1}&copyType=${copyType}&location=${locationFilter}`)
                                i.bi.bi-chevron-left
                        each i in Array.from({length: Math.min(pagination.totalPages, 10)}, (_, j) => j + 1)
                            - const pageNum = pagination.page <= 5 ? i : pagination.page - 5 + i
                            if pageNum <= pagination.totalPages
                                li.page-item(class=pageNum === pagination.page ? 'active' : '')
                                    a.page-link.text-bg-dark.border-secondary(href=`/games/copies?page=${pageNum}&copyType=${copyType}&location=${locationFilter}`) #{pageNum}
                        li.page-item(class=!pagination.hasNext ? 'disabled' : '')
                            a.page-link.text-bg-dark.border-secondary(href=`/games/copies?page=${pagination.page + 1}&copyType=${copyType}&location=${locationFilter}`)
                                i.bi.bi-chevron-right
            .text-center.text-white-50.small.mb-3
                | Showing #{(pagination.page - 1) * 24 + 1} - #{Math.min(pagination.page * 24, pagination.totalCount)} of #{pagination.totalCount} copies

block scripts
    script(type="module" src="/js/stub.gen.js")
    script.
        // Initialize Select2 for filters
        $(document).ready(function() {
            $('#locationFilter').select2({
                theme: 'bootstrap-5',
                placeholder: 'All locations',
                allowClear: true
            });
        });
